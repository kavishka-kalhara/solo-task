<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Leveling - Arise and Conquer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #0a0a1a;
            --secondary: #1a1a2e;
            --accent: #4a00e0;
            --accent-light: #8e2de2;
            --text: #ffffff;
            --text-dim: #a0a0a0;
            --xp-bar: linear-gradient(90deg, #4a00e0, #8e2de2);
            --card-bg: rgba(26, 26, 46, 0.85);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --glow: 0 0 25px rgba(138, 43, 226, 0.6);
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff3860;
            --gold: #ffd700;
            --blue: #00a8ff;
            --purple: #9c27b0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Rajdhani', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Utility classes */
        .hidden { display: none !important; }

        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(74, 0, 224, 0.15) 0%, transparent 70%);
            animation: float 20s infinite linear;
        }

        .bg-circle:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 10%;
            left: 5%;
            animation-duration: 25s;
        }

        .bg-circle:nth-child(2) {
            width: 500px;
            height: 500px;
            top: 60%;
            right: 10%;
            animation-duration: 30s;
            animation-delay: 5s;
        }

        .bg-circle:nth-child(3) {
            width: 200px;
            height: 200px;
            bottom: 20%;
            left: 20%;
            animation-duration: 20s;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(90deg); }
            50% { transform: translateY(0) rotate(180deg); }
            75% { transform: translateY(20px) rotate(270deg); }
        }

        /* Particles */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(138, 43, 226, 0.6);
            border-radius: 50%;
            animation: particle-float 15s infinite linear;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        @keyframes particle-float {
            0% { transform: translateY(100vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(100px) rotate(360deg); opacity: 0; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
            position: relative;
        }

        .header-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(40px);
            z-index: -1;
            animation: pulse-glow 4s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
        }

        h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, #fff, #8e2de2, #4a00e0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 15px rgba(142, 45, 226, 0.4);
            letter-spacing: 4px;
            position: relative;
            display: inline-block;
            font-family: 'Orbitron', sans-serif;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 2px 15px rgba(142, 45, 226, 0.4); }
            to { text-shadow: 0 2px 25px rgba(142, 45, 226, 0.8), 0 0 30px rgba(74, 0, 224, 0.4); }
        }

        .tagline {
            color: var(--text-dim);
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-style: italic;
            letter-spacing: 3px;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* User Info */
        .user-info {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            animation: slideInDown 0.8s ease-out 0.5s both;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-info:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 20px rgba(138, 43, 226, 0.5);
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-name {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--accent-light);
        }

        .user-level-display {
            color: var(--text-dim);
            font-size: 1.1rem;
            margin-top: 5px;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-stats {
            display: flex;
            gap: 25px;
            text-align: center;
        }

        .user-stat {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--gold);
        }

        .user-stat-label {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 35px;
            margin-bottom: 50px;
            animation: slideInUp 0.8s ease-out 0.7s both;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: var(--shadow), var(--glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(to right, var(--accent), var(--accent-light));
            animation: progress-line 2s ease-in-out infinite alternate;
        }

        @keyframes progress-line {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .level-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 30px rgba(138, 43, 226, 0.7);
        }

        .level-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .level-number {
            font-size: 6.5rem;
            font-weight: bold;
            margin-bottom: 35px;
            background: linear-gradient(to right, #4a00e0, #8e2de2);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(138, 43, 226, 0.8);
            position: relative;
            display: inline-block;
            font-family: 'Orbitron', sans-serif;
            animation: numberPulse 2s ease-in-out infinite;
        }

        @keyframes numberPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .xp-info {
            margin-bottom: 30px;
        }

        .xp-text {
            font-size: 1.4rem;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .xp-bar-container {
            height: 32px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4a00e0, #8e2de2, #4a00e0);
            background-size: 200% 100%;
            border-radius: 16px;
            transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
            animation: xpShimmer 3s infinite linear;
        }

        @keyframes xpShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--accent), var(--accent-light));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 20px rgba(138, 43, 226, 0.5);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-value {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 18px;
            color: var(--accent-light);
            text-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover .stat-value {
            transform: scale(1.1);
            color: var(--gold);
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Main Counter */
        .main-counter-section {
            margin-bottom: 50px;
            animation: slideInUp 0.8s ease-out 0.9s both;
        }

        .main-counter-card {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 60px;
            box-shadow: var(--shadow), var(--glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }

        .main-counter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(to right, var(--accent), var(--accent-light), var(--accent));
            background-size: 200% 100%;
            animation: shimmer-line 3s infinite linear;
        }

        @keyframes shimmer-line {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .main-counter-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 35px rgba(138, 43, 226, 0.8);
        }

        .main-counter-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .main-counter-value {
            font-size: 6rem;
            font-weight: bold;
            margin-bottom: 25px;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s ease;
            animation: counterPulse 2s ease-in-out infinite;
        }

        @keyframes counterPulse {
            0%, 100% { text-shadow: 0 0 30px rgba(255, 215, 0, 0.9); }
            50% { text-shadow: 0 0 50px rgba(255, 215, 0, 1), 0 0 70px rgba(255, 215, 0, 0.7); }
        }

        .main-counter-subtitle {
            color: var(--text-dim);
            font-size: 1.5rem;
            margin-bottom: 35px;
        }

        .main-counter-date {
            color: var(--accent-light);
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Targets Section */
        .targets-section {
            margin-bottom: 40px;
            animation: slideInUp 0.8s ease-out 1.1s both;
        }

        .section-title {
            font-size: 2.2rem;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            padding-bottom: 20px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--accent-light), transparent);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(74, 0, 224, 0.4);
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2rem;
            z-index: 10;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(74, 0, 224, 0.6);
        }

        .btn:hover::before {
            left: 100%;
        }

        .targets-list {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            box-shadow: var(--shadow);
            min-height: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .target-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 18px;
            padding: 30px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 6px solid var(--accent);
            position: relative;
            overflow: hidden;
            animation: slideInRight 0.5s ease-out both;
            z-index: 10;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .target-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .target-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(10px) translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .target-item:hover::before {
            opacity: 1;
        }

        .target-item.completed {
            border-left-color: var(--success);
            opacity: 0.8;
            animation: completePulse 0.6s ease-out;
        }

        @keyframes completePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .target-info h3 {
            margin-bottom: 12px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .target-info p {
            color: var(--text-dim);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .target-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--warning);
            font-weight: bold;
            margin-top: 8px;
            font-size: 1.1rem;
        }

        /* Task Timer */
        .timer-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timer-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            min-width: 140px;
            text-align: center;
        }

        .timer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            z-index: 10;
        }

        .timer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .timer-btn.start {
            background: rgba(0, 255, 136, 0.2);
            color: white;
        }

        .timer-btn.start:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .timer-btn.pause {
            background: rgba(255, 170, 0, 0.2);
            color: white;
        }

        .timer-btn.pause:hover {
            background: rgba(255, 170, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
        }

        .timer-btn.reset {
            background: rgba(255, 56, 96, 0.2);
            color: white;
        }

        .timer-btn.reset:hover {
            background: rgba(255, 56, 96, 0.3);
            box-shadow: 0 0 15px rgba(255, 56, 96, 0.5);
        }

        .timer-btn.fullscreen {
            background: rgba(138, 43, 226, 0.2);
            color: white;
        }

        .timer-btn.fullscreen:hover {
            background: rgba(138, 43, 226, 0.3);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        }

        .target-actions {
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        .btn-complete {
            background: rgba(74, 224, 0, 0.2);
            color: var(--success);
            border: 1px solid rgba(74, 224, 0, 0.3);
            padding: 14px 22px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }

        .btn-complete:hover {
            background: rgba(74, 224, 0, 0.3);
            box-shadow: 0 0 20px rgba(74, 224, 0, 0.6);
            transform: scale(1.05);
        }

        .btn-delete {
            background: rgba(224, 0, 0, 0.2);
            color: var(--danger);
            border: 1px solid rgba(224, 0, 0, 0.3);
            padding: 14px 22px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }

        .btn-delete:hover {
            background: rgba(224, 0, 0, 0.3);
            box-shadow: 0 0 20px rgba(224, 0, 0, 0.6);
            transform: scale(1.05);
        }

        .empty-targets {
            text-align: center;
            padding: 100px 30px;
            color: var(--text-dim);
        }

        .empty-targets p {
            margin-bottom: 35px;
            font-size: 1.5rem;
        }

        /* Analytics Section */
        .analytics-section {
            margin-bottom: 50px;
            animation: slideInUp 0.8s ease-out 1.3s both;
        }

        .analytics-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .time-details {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            display: none;
        }

        .time-details.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .time-sessions {
            margin-top: 15px;
        }

        .time-session {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Friends Section */
        .friends-section {
            margin-bottom: 50px;
            animation: slideInUp 0.8s ease-out 1.5s both;
        }

        .friends-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .friends-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .friends-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friends-tab.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
        }

        .friends-content {
            display: none;
        }

        .friends-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .search-friends {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .search-friends input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: var(--text);
            font-size: 1.1rem;
        }

        .search-friends input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        }

        .friends-list, .requests-list, .search-results {
            margin-top: 20px;
        }

        .friend-item, .request-item, .search-result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .friend-item:hover, .request-item:hover, .search-result-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(10px);
        }

        .friend-info, .request-info, .search-result-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .friend-avatar, .request-avatar, .search-result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .friend-avatar img, .request-avatar img, .search-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .friend-details h4, .request-details h4, .search-result-details h4 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .friend-details p, .request-details p, .search-result-details p {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .friend-actions, .request-actions, .search-result-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 10px 18px;
            font-size: 1rem;
            border-radius: 20px;
        }

        .btn-accept {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .btn-accept:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .btn-decline {
            background: rgba(255, 56, 96, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 56, 96, 0.3);
        }

        .btn-decline:hover {
            background: rgba(255, 56, 96, 0.3);
            box-shadow: 0 0 15px rgba(255, 56, 96, 0.5);
        }

        .btn-add {
            background: rgba(138, 43, 226, 0.2);
            color: var(--accent-light);
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .btn-add:hover {
            background: rgba(138, 43, 226, 0.3);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        }

        /* Leaderboard Section */
        .leaderboard-section {
            margin-bottom: 50px;
            animation: slideInUp 0.8s ease-out 1.7s both;
        }

        .leaderboard-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .leaderboard-list {
            margin-top: 25px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(10px);
        }

        .leaderboard-rank {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gold);
            min-width: 50px;
            text-align: center;
        }

        .leaderboard-user {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .leaderboard-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            overflow: hidden;
        }

        .leaderboard-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .leaderboard-info h4 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .leaderboard-info p {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .leaderboard-stats {
            text-align: right;
        }

        .leaderboard-level {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-light);
        }

        .leaderboard-xp {
            color: var(--text-dim);
            font-size: 1rem;
        }

        /* Settings Section */
        .settings-section {
            margin-bottom: 50px;
            animation: slideInUp 0.8s ease-out 1.9s both;
        }

        .settings-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .settings-group {
            margin-bottom: 30px;
        }

        .settings-group h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-info h4 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .setting-info p {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: modalBg 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        @keyframes modalBg {
            from { backdrop-filter: blur(0); background: rgba(0, 0, 0, 0); }
            to { backdrop-filter: blur(10px); background: rgba(0, 0, 0, 0.9); }
        }

        .modal-content {
            background: var(--secondary);
            border-radius: 30px;
            padding: 50px;
            width: 90%;
            max-width: 650px;
            box-shadow: var(--shadow), 0 0 50px rgba(138, 43, 226, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            animation: modalAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(15px);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalAppear {
            0% { opacity: 0; transform: scale(0.8) translateY(50px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal h2 {
            margin-bottom: 35px;
            text-align: center;
            color: var(--accent-light);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 2.2rem;
        }

        .modal h2::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 20%;
            width: 60%;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--accent-light), transparent);
        }

        .form-group {
            margin-bottom: 35px;
        }

        .form-group label {
            display: block;
            margin-bottom: 15px;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
        }

        .form-control {
            width: 100%;
            padding: 18px 22px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: var(--text);
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
            background: rgba(255, 255, 255, 0.12);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 40px;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        /* Profile Picture Selection */
        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
        }

        .avatar-option.selected {
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--card-bg);
            border-radius: 18px;
            padding: 25px 30px;
            box-shadow: var(--shadow), 0 0 25px rgba(138, 43, 226, 0.7);
            border-left: 6px solid var(--accent);
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            max-width: 450px;
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification h4 {
            margin-bottom: 8px;
            color: var(--accent-light);
            font-size: 1.4rem;
        }

        .notification p {
            font-size: 1.2rem;
            color: var(--text-dim);
        }

        /* Level Up */
        .level-up {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            text-align: center;
            backdrop-filter: blur(20px);
        }

        .level-up.show {
            display: flex;
            animation: levelUpBg 0.5s ease;
        }

        @keyframes levelUpBg {
            from { backdrop-filter: blur(0); background: rgba(0, 0, 0, 0); }
            to { backdrop-filter: blur(20px); background: rgba(0, 0, 0, 0.95); }
        }

        .level-up-content {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 70px;
            max-width: 650px;
            width: 90%;
            box-shadow: 0 0 80px rgba(74, 0, 224, 0.9);
            border: 3px solid var(--accent-light);
            animation: levelUpPulse 2s infinite, levelUpAppear 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        @keyframes levelUpAppear {
            0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
            100% { opacity: 1; transform: scale(1) rotate(0); }
        }

        @keyframes levelUpPulse {
            0% { box-shadow: 0 0 80px rgba(74, 0, 224, 0.7); }
            50% { box-shadow: 0 0 100px rgba(142, 45, 226, 1); }
            100% { box-shadow: 0 0 80px rgba(74, 0, 224, 0.7); }
        }

        .level-up h2 {
            font-size: 5.5rem;
            margin-bottom: 35px;
            background: linear-gradient(to right, #4a00e0, #8e2de2, #00ff88);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(138, 43, 226, 0.9);
            font-family: 'Orbitron', sans-serif;
            animation: levelUpText 1s ease-in-out infinite alternate;
        }

        @keyframes levelUpText {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .level-up p {
            font-size: 2rem;
            margin-bottom: 45px;
            color: var(--text-dim);
        }

        /* Fullscreen Timer */
        .fullscreen-timer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
        }

        .fullscreen-timer.active {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .fullscreen-timer-content {
            text-align: center;
            padding: 50px;
            background: var(--card-bg);
            border-radius: 30px;
            box-shadow: var(--shadow), 0 0 50px rgba(138, 43, 226, 0.7);
            border: 3px solid var(--accent-light);
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(15px);
        }

        .fullscreen-timer h2 {
            font-size: 3rem;
            margin-bottom: 30px;
            color: var(--accent-light);
        }

        .fullscreen-timer-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
            margin: 40px 0;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
        }

        .fullscreen-timer-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .fullscreen-timer .timer-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #f00;
            border-radius: 0;
            animation: confetti-fall 5s linear forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Achievement Badge */
        .achievement-badge {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: var(--card-bg);
            border-radius: 18px;
            padding: 25px;
            box-shadow: var(--shadow), 0 0 25px rgba(138, 43, 226, 0.7);
            border-left: 6px solid gold;
            transform: translateX(-150%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(15px);
        }

        .achievement-badge.show {
            transform: translateX(0);
        }

        .achievement-icon {
            font-size: 2.8rem;
            color: gold;
            animation: achievementGlow 2s ease-in-out infinite alternate;
        }

        @keyframes achievementGlow {
            from { filter: drop-shadow(0 0 5px gold); }
            to { filter: drop-shadow(0 0 15px gold); }
        }

        .achievement-text h4 {
            color: gold;
            margin-bottom: 8px;
            font-size: 1.4rem;
        }

        .achievement-text p {
            font-size: 1.1rem;
            color: var(--text-dim);
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 26, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 35px;
            backdrop-filter: blur(20px);
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 10px solid rgba(138, 43, 226, 0.3);
            border-top: 10px solid var(--accent-light);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            font-size: 1.5rem;
            color: var(--text-dim);
            animation: loadingText 2s ease-in-out infinite;
        }

        @keyframes loadingText {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--card-bg);
            border-radius: 40px;
            padding: 14px 24px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .sync-status:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .sync-status.syncing {
            color: var(--warning);
        }

        .sync-status.synced {
            color: var(--success);
        }

        .sync-status.error {
            color: var(--danger);
        }

        /* Navigation */
        .app-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: var(--card-bg);
            border: none;
            color: var(--text);
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            box-shadow: 0 8px 25px rgba(74, 0, 224, 0.4);
        }

        /* Login Form */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 50px;
            box-shadow: var(--shadow), var(--glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-tab.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .google-signin {
            background: white;
            color: #4285F4;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .google-signin:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* Email/Password Form */
        .email-form {
            margin-top: 25px;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: var(--text);
            font-size: 1.1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        }

        .form-submit {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .form-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 0, 224, 0.4);
        }

        .error-message {
            color: var(--danger);
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 56, 96, 0.1);
            border-radius: 8px;
            display: none;
        }

        .success-message {
            color: #4CAF50;
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
            display: none;
        }

        .forgot-password-link {
            text-align: center;
            margin-top: 12px;
        }

        .forgot-password-link a {
            color: var(--accent-light);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .forgot-password-link a:hover {
            color: var(--accent);
            text-shadow: 0 0 10px rgba(138, 45, 226, 0.5);
        }

        /* =============================================== */
        /* MOBILE DASHBOARD - REDESIGNED */
        /* =============================================== */

        .mobile-dashboard {
            display: none;
            margin-bottom: 30px;
        }

        .mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }

        .mobile-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mobile-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.6);
        }

        .mobile-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .mobile-user-details h3 {
            font-size: 1.3rem;
            color: var(--accent-light);
            margin-bottom: 4px;
        }

        .mobile-user-details p {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .mobile-level-display {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-level-display .level {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--accent-light);
            margin-bottom: 5px;
            font-family: 'Orbitron', sans-serif;
        }

        .mobile-level-display .label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mobile-main-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .mobile-stat-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .mobile-stat-card:active {
            transform: scale(0.98);
        }

        .mobile-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent-light);
        }

        .mobile-stat-label {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .mobile-xp-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow), var(--glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .mobile-xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mobile-xp-title {
            font-size: 1.1rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mobile-xp-progress {
            font-size: 0.9rem;
            color: var(--accent-light);
            font-weight: bold;
        }

        .mobile-xp-bar-container {
            height: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4a00e0, #8e2de2, #4a00e0);
            background-size: 200% 100%;
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            animation: xpShimmer 3s infinite linear;
        }

        .mobile-xp-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .mobile-quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .mobile-action-btn {
            background: var(--card-bg);
            border: none;
            color: var(--text);
            padding: 18px 15px;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-action-btn:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.05);
        }

        .mobile-action-btn i {
            font-size: 1.5rem;
            color: var(--accent-light);
        }

        .mobile-action-btn span {
            font-size: 0.9rem;
        }

        .mobile-main-counter {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: var(--shadow), var(--glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            margin-bottom: 20px;
        }

        .mobile-counter-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .mobile-counter-value {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.9);
            font-family: 'Orbitron', sans-serif;
        }

        .mobile-counter-subtitle {
            color: var(--text-dim);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .mobile-counter-date {
            color: var(--accent-light);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mobile-counter-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(74, 0, 224, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            width: 100%;
        }

        .mobile-counter-btn:active {
            transform: scale(0.98);
        }

        .mobile-recent-targets {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-recent-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-recent-title span {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .mobile-target-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }

        .mobile-target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mobile-target-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text);
        }

        .mobile-target-xp {
            font-size: 0.9rem;
            color: var(--accent-light);
            font-weight: bold;
        }

        .mobile-target-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .mobile-target-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            border-radius: 3px;
        }

        .mobile-target-time {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .mobile-target-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .mobile-target-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mobile-target-btn:active {
            transform: scale(0.95);
        }

        .mobile-target-btn.start {
            background: rgba(0, 255, 136, 0.15);
            color: var(--success);
        }

        .mobile-target-btn.complete {
            background: rgba(74, 0, 224, 0.15);
            color: var(--accent-light);
        }

        .mobile-empty-targets {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .mobile-empty-targets p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .mobile-add-target-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(74, 0, 224, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            width: 100%;
        }

        .mobile-add-target-btn:active {
            transform: scale(0.98);
        }

        /* =============================================== */
        /* RESPONSIVE DESIGN */
        /* =============================================== */

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .tagline {
                font-size: 1.2rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .user-stats {
                justify-content: center;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .target-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .target-actions {
                margin-top: 20px;
                width: 100%;
                justify-content: flex-end;
            }
            
            .timer-container {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .level-number {
                font-size: 5rem;
            }

            .section-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .main-counter-value {
                font-size: 4.5rem;
            }

            .main-counter-card {
                padding: 40px 25px;
            }

            .level-up-content {
                padding: 40px 25px;
            }

            .level-up h2 {
                font-size: 4rem;
            }

            .fullscreen-timer-display {
                font-size: 3rem;
                padding: 20px;
            }

            .fullscreen-timer-controls {
                flex-wrap: wrap;
            }

            .app-navigation {
                flex-wrap: wrap;
            }

            .leaderboard-item, .friend-item, .request-item, .search-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .leaderboard-stats, .friend-actions, .request-actions, .search-result-actions {
                align-self: flex-end;
            }

            .avatar-selection {
                grid-template-columns: repeat(3, 1fr);
            }

            .search-friends {
                flex-direction: column;
            }

            .friends-tabs {
                flex-direction: column;
            }

            /* Hide desktop dashboard, show mobile dashboard */
            .dashboard {
                display: none;
            }

            .mobile-dashboard {
                display: block;
            }

            .main-counter-section {
                display: none;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }

            .user-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .user-name {
                font-size: 1.3rem;
            }

            .user-stats {
                gap: 10px;
            }

            .user-stat {
                padding: 8px 12px;
            }

            .user-stat-value {
                font-size: 1.2rem;
            }

            .mobile-main-stats {
                grid-template-columns: 1fr;
            }

            .mobile-quick-actions {
                grid-template-columns: 1fr;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .modal h2 {
                font-size: 1.8rem;
            }

            .btn {
                padding: 15px 25px;
                font-size: 1rem;
            }

            .avatar-selection {
                grid-template-columns: repeat(2, 1fr);
            }

            .avatar-option {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
        }

        /* Icon Colors */
        .fa-bullseye { color: var(--danger); }
        .fa-check-circle { color: var(--success); }
        .fa-calendar-day { color: var(--gold); }
        .fa-star { color: var(--gold); }
        .fa-bolt { color: var(--blue); }
        .fa-trophy { color: var(--gold); }
        .fa-gem { color: var(--purple); }
        .fa-flag-checkered { color: var(--success); }
        .fa-clock { color: var(--warning); }
        .fa-hourglass-half { color: var(--accent-light); }
        .fa-fire { color: var(--warning); }
        .fa-users { color: var(--blue); }
        .fa-cog { color: var(--text-dim); }
        .fa-chart-line { color: var(--success); }
        .fa-user-friends { color: var(--accent-light); }
        .fa-chart-bar { color: var(--accent-light); }

        /* Enhanced Particle Effects */
        .success-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .success-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: success-burst 2s ease-out forwards;
            box-shadow: 0 0 15px var(--success);
        }

        @keyframes success-burst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.5) rotate(360deg) translateY(-200px);
                opacity: 0;
            }
        }

        .level-up-explosion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            pointer-events: none;
        }

        .level-up-particle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--gold);
            border-radius: 50%;
            animation: level-up-burst 3s ease-out forwards;
            box-shadow: 0 0 20px var(--gold);
        }

        @keyframes level-up-burst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            30% {
                transform: scale(2) rotate(120deg);
                opacity: 1;
            }
            100% {
                transform: scale(0.3) rotate(360deg) translateY(-300px);
                opacity: 0;
            }
        }

        /* Enhanced Achievement Notification */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--gold), #ffaa00);
            color: var(--primary);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
            z-index: 1500;
            transform: translateX(400px);
            animation: achievement-slide-in 0.5s ease-out forwards, achievement-glow 2s ease-in-out infinite;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid #fff;
        }

        @keyframes achievement-slide-in {
            to {
                transform: translateX(0);
            }
        }

        @keyframes achievement-glow {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
            }
            50% {
                box-shadow: 0 10px 40px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6);
            }
        }

        /* Streak Counter */
        .streak-indicator {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            animation: streak-pulse 2s ease-in-out infinite;
        }

        @keyframes streak-pulse {
            0%, 100% {
                transform: translateY(-50%) scale(1);
            }
            50% {
                transform: translateY(-50%) scale(1.1);
            }
        }

        /* Daily Quest Section */
        .daily-quest-card {
            background: linear-gradient(135deg, var(--card-bg), rgba(255, 215, 0, 0.1));
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            animation: quest-shimmer 3s ease-in-out infinite;
        }

        @keyframes quest-shimmer {
            0%, 100% {
                border-color: var(--gold);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            }
            50% {
                border-color: #ffaa00;
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            }
        }

        .quest-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #ffaa00);
            border-radius: 4px;
            transition: width 0.8s ease;
            animation: progress-glow 2s ease-in-out infinite;
        }

        @keyframes progress-glow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
        }

        /* Enhanced Button Animations */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-enhanced:hover::before {
            left: 100%;
        }

        .btn-enhanced:active {
            transform: scale(0.95);
        }

        /* Sound Toggle */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(74, 0, 224, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(74, 0, 224, 0.6);
        }

        /* Pomodoro Timer Enhancements */
        .pomodoro-phases {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .phase-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .phase-indicator.active {
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }

        .phase-indicator.completed {
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
        }

        /* Focus Mode Overlay - Game-like RPG Interface */
        .focus-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,0,40,0.95));
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }

        .focus-game-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 24px;
            max-width: 900px;
            width: 95%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .focus-game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,215,0,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            pointer-events: none;
            opacity: 0.3;
        }

        /* Game Header */
        .focus-game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .hunter-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hunter-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #000;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .hunter-info {
            color: white;
        }

        .hunter-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .hunter-level {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .focus-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        .stat-bar {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-bar-container {
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .stat-bar-fill.focus-energy {
            background: linear-gradient(90deg, #ff4444, #ff6666);
            box-shadow: 0 0 10px rgba(255,68,68,0.5);
        }

        .stat-bar-fill.xp-progress {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            box-shadow: 0 0 10px rgba(76,175,80,0.5);
        }

        /* Game Main Area */
        .focus-game-main {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .quest-panel {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .quest-panel h3 {
            color: #FFD700;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quest-phases {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .phase-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .phase-indicator.active {
            background: rgba(255,215,0,0.2);
            border-color: #FFD700;
            color: #FFD700;
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
        }

        /* Timer Arena */
        .timer-arena {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .arena-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, rgba(0,0,0,0.3) 70%);
            border-radius: 50%;
            animation: arenaGlow 3s ease-in-out infinite;
        }

        @keyframes arenaGlow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .timer-crystal {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .crystal-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: crystalPulse 2s ease-in-out infinite;
        }

        /* Circular Progress Ring */
        .progress-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            z-index: 3;
        }
        .progress-ring__circle {
            fill: transparent;
            stroke: #FFD700;
            stroke-width: 8;
            stroke-linecap: round;
            filter: drop-shadow(0 0 8px rgba(255,215,0,0.6));
            transition: stroke 0.3s ease, stroke-dashoffset 0.3s linear;
        }

        @keyframes crystalPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .focus-time {
            font-size: 4rem;
            font-family: 'Orbitron', sans-serif;
            color: #FFD700;
            text-shadow: 0 0 30px rgba(255,215,0,0.8);
            margin: 0;
            position: relative;
            z-index: 3;
        }

        .crystal-runes {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .rune {
            font-size: 1.5rem;
            animation: runeFloat 3s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.5s);
        }

        .rune:nth-child(1) { --i: 0; }
        .rune:nth-child(2) { --i: 1; }
        .rune:nth-child(3) { --i: 2; }
        .rune:nth-child(4) { --i: 3; }

        @keyframes runeFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Game Controls */
        .game-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
            border: 2px solid rgba(255,215,0,0.4);
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .game-btn:hover {
            background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(255,215,0,0.2));
            border-color: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }

        .game-btn i {
            font-size: 1.2rem;
        }

        .game-btn span {
            font-size: 0.8rem;
        }

        /* Game Footer */
        .focus-game-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 1px solid rgba(255,215,0,0.2);
            font-size: 0.9rem;
        }

        .achievement-preview, .session-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #FFD700;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .focus-game-main {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .focus-game-header {
                flex-direction: column;
                gap: 16px;
            }
            
            .focus-stats {
                width: 100%;
            }
            
            .focus-time {
                font-size: 3rem;
            }
            
            .game-controls {
                gap: 8px;
            }
            
            .game-btn {
                min-width: 70px;
                padding: 10px 12px;
            }
        }

        /* Daily Quests Section */
        .daily-quests-section {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .quest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quest-item:last-child {
            border-bottom: none;
        }

        .quest-info {
            flex: 1;
        }

        .quest-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--text);
        }

        .quest-description {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .quest-reward {
            background: var(--gold);
            color: var(--primary);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Store Section (upgraded) */
        .store-section {
            margin-bottom: 50px;
        }
        .store-section .section-title h2 {
            background: linear-gradient(90deg, #fff, var(--accent-light), #7aa2ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .store-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .store-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 0, 224, 0.3);
        }
        .store-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .store-item-icon {
            font-size: 1.8rem;
        }
        .store-item-info {
            display: flex;
            flex-direction: column;
        }
        .store-item-name {
            font-weight: 600;
        }
        .store-item-price {
            color: var(--text-dim);
        }
        .store-item-actions .badge.owned {
            color: var(--accent-light);
        }

        /* Power-up Effects */
        .power-up-active {
            animation: power-up-glow 2s ease-in-out infinite;
        }

        @keyframes power-up-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            }
            50% {
                box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
            }
        }

        /* Combo Multiplier */
        .combo-multiplier {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            animation: combo-bounce 1s ease-in-out infinite;
        }

        @keyframes combo-bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Mobile-only Focus overlay scrolling */
        @media (max-width: 768px) {
            #focus-overlay {
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                align-items: flex-start; /* allow content to start at top when scrolled */
            }
            #focus-overlay .focus-container {
                padding-bottom: 64px; /* extra space for scrolling */
            }
        }
        @media (min-width: 769px) {
            #focus-overlay {
                overflow: hidden; /* keep desktop non-scroll */
            }
        }
    </style>
</head>
<body>
    <div class="animated-bg">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>
    
    <div class="floating-particles" id="particles-container"></div>
    
    <!-- Login/Register Modal -->
    <div class="modal" id="auth-modal">
        <div class="login-container">
            <div class="login-card">
                <h2><i class="fas fa-user-shield"></i> Hunter Gateway</h2>
                <p style="color: var(--text-dim); margin-bottom: 30px; font-size: 1.2rem;">Sign in to continue your journey</p>
                
                <div class="login-tabs">
                    <button class="login-tab active" data-tab="signin">Sign In</button>
                    <button class="login-tab" data-tab="signup">Sign Up</button>
                </div>
                
                <!-- Sign In Form -->
                <div class="login-form active" id="signin-form">
                    <div class="email-form">
                        <input type="email" id="signin-email" class="form-input" placeholder="Email Address">
                        <input type="password" id="signin-password" class="form-input" placeholder="Password">
                        <button class="form-submit" id="signin-email-btn">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                        <div class="forgot-password-link">
                            <a href="#" id="forgot-password-link">
                                <i class="fas fa-key"></i> Forgot Password?
                            </a>
                        </div>
                    </div>
                    
                    <div class="error-message" id="signin-error"></div>
                    <div class="success-message" id="reset-success" style="display: none;"></div>
                    
                    <div style="text-align: center; margin: 25px 0; color: var(--text-dim);">OR</div>
                    
                    <button class="google-signin" id="google-signin">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                </div>
                
                <!-- Sign Up Form -->
                <div class="login-form" id="signup-form">
                    <div class="email-form">
                        <input type="text" id="signup-name" class="form-input" placeholder="Hunter Name">
                        <input type="email" id="signup-email" class="form-input" placeholder="Email Address">
                        <input type="password" id="signup-password" class="form-input" placeholder="Password (min 6 characters)">
                        <button class="form-submit" id="signup-email-btn">
                            <i class="fas fa-user-plus"></i> Create Account
                        </button>
                    </div>
                    
                    <div class="error-message" id="signup-error"></div>
                    
                    <div style="text-align: center; margin: 25px 0; color: var(--text-dim);">OR</div>
                    
                    <button class="google-signin" id="google-signup">
                        <i class="fab fa-google"></i> Sign up with Google
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Initializing Hunter System...</p>
    </div>
    
    <div class="container" id="main-container" style="display: none;">
        <header>
            <div class="header-glow"></div>
            <h1>SOLO LEVELING</h1>
            <p class="tagline">Arise and conquer your targets</p>
        </header>
        
        <!-- Enhanced User Profile Section -->
        <div class="user-info" id="user-profile">
            <div class="user-details">
                <div class="user-avatar" id="user-avatar">
                    <img id="user-avatar-img" src="" alt="Profile" style="display: none;">
                    <span id="user-avatar-text">SL</span>
                </div>
                <div>
                    <div class="user-name" id="user-name-display">Hunter</div>
                    <div class="user-level-display">Level <span id="user-level">1</span> Hunter</div>
                </div>
            </div>
            <div class="user-stats">
                <div class="user-stat">
                    <div class="user-stat-value" id="user-targets">0</div>
                    <div class="user-stat-label">Targets</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value" id="user-completed">0</div>
                    <div class="user-stat-label">Completed</div>
                </div>
                <div class="user-stat">
                    <div class="user-stat-value" id="user-days">14</div>
                    <div class="user-stat-label">Days Left</div>
                </div>
            </div>
            <div class="user-controls">
                <button class="btn btn-enhanced" id="focus-mode-btn"><i class="fas fa-eye"></i> Focus Mode</button>
                <button class="btn" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="app-navigation">
            <button class="nav-btn active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="nav-btn" data-section="targets">
                <i class="fas fa-tasks"></i> Targets
            </button>
            <button class="nav-btn" data-section="analytics">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            <button class="nav-btn" data-section="friends">
                <i class="fas fa-user-friends"></i> Friends
            </button>
            <button class="nav-btn" data-section="leaderboard">
                <i class="fas fa-trophy"></i> Leaderboard
            </button>
            <button class="nav-btn" data-section="store">
                <i class="fas fa-shopping-cart"></i> Shop
            </button>
            <button class="nav-btn" data-section="inventory">
                <i class="fas fa-box-open"></i> Inventory
            </button>
            <button class="nav-btn" data-section="settings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
        
        <!-- Desktop Dashboard Section -->
        <div class="section-content" id="dashboard-section">
            <div class="dashboard">
                <div class="level-card">
                    <div class="level-title">
                        <i class="fas fa-trophy"></i>
                        CURRENT LEVEL
                    </div>
                    <div class="level-number" id="current-level">1</div>
                    <div class="xp-info">
                        <div class="xp-text">
                            <i class="fas fa-bolt"></i>
                            <span id="xp-text">500 XP to Level 2</span>
                        </div>
                        <div class="xp-bar-container">
                            <div class="xp-bar" id="xp-bar" style="width: 0%"></div>
                        </div>
                        <div class="xp-text">
                            <i class="fas fa-chart-line"></i>
                            <span id="xp-details">EXPERIENCE 0 / 500</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-bullseye"></i>
                            <span id="total-targets">0</span>
                        </div>
                        <div class="stat-label">
                            <i class="fas fa-list"></i>
                            TOTAL TARGETS
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-check-circle"></i>
                            <span id="completed-targets">0</span>
                        </div>
                        <div class="stat-label">
                            <i class="fas fa-flag-checkered"></i>
                            COMPLETED
                        </div>
                    </div>
                    <div class="stat-card" id="day-counter-card">
                        <div class="stat-value">
                            <i class="fas fa-calendar-day"></i>
                            <span id="day-counter">0</span>
                        </div>
                        <div class="stat-label">
                            <i class="fas fa-hourglass-half"></i>
                            DAYS UNTIL GOAL
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-star"></i>
                            <span id="total-xp">0</span>
                        </div>
                        <div class="stat-label">
                            <i class="fas fa-gem"></i>
                            TOTAL XP
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Counter Section -->
            <div class="main-counter-section">
                <div class="main-counter-card">
                    <div class="main-counter-title">
                        <i class="fas fa-calendar-day"></i>
                        MAIN DAY COUNTER
                    </div>
                    <div class="main-counter-value" id="main-counter">14</div>
                    <div class="main-counter-subtitle">Days until your goal</div>
                    <div class="main-counter-date" id="main-counter-date">
                        <i class="fas fa-flag"></i>
                        <span id="counter-date-text">December 31, 2023</span>
                    </div>
                    <button class="btn" id="set-date-btn">
                        <i class="fas fa-edit"></i> Set Target Date
                    </button>
                </div>
            </div>
            
            <!-- Mobile Dashboard Section - REDESIGNED -->
            <div class="mobile-dashboard">
                <!-- Mobile Header -->
                <div class="mobile-header">
                    <div class="mobile-user-info">
                        <div class="mobile-user-avatar" id="mobile-user-avatar">
                            <img id="mobile-user-avatar-img" src="" alt="Profile" style="display: none;">
                            <span id="mobile-user-avatar-text">SL</span>
                        </div>
                        <div class="mobile-user-details">
                            <h3 id="mobile-user-name">Hunter</h3>
                            <p>Level <span id="mobile-user-level">1</span> Hunter</p>
                        </div>
                    </div>
                    <div class="mobile-level-display">
                        <div class="level" id="mobile-level">1</div>
                        <div class="label">Level</div>
                    </div>
                </div>
                
                <!-- Main Stats -->
                <div class="mobile-main-stats">
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-value" id="mobile-total-targets">0</div>
                        <div class="mobile-stat-label">Total Targets</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-value" id="mobile-completed-targets">0</div>
                        <div class="mobile-stat-label">Completed</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-value" id="mobile-total-xp">0</div>
                        <div class="mobile-stat-label">Total XP</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div class="mobile-stat-value" id="mobile-days-left">14</div>
                        <div class="mobile-stat-label">Days Left</div>
                    </div>
                </div>
                
                <!-- XP Progress -->
                <div class="mobile-xp-card">
                    <div class="mobile-xp-header">
                        <div class="mobile-xp-title">Level Progress</div>
                        <div class="mobile-xp-progress" id="mobile-xp-progress">0 / 500 XP</div>
                    </div>
                    <div class="mobile-xp-bar-container">
                        <div class="mobile-xp-bar" id="mobile-xp-bar" style="width: 0%"></div>
                    </div>
                    <div class="mobile-xp-details">
                        <span>Level <span id="mobile-current-level">1</span></span>
                        <span>Level <span id="mobile-next-level">2</span></span>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mobile-quick-actions">
                    <button class="mobile-action-btn" id="mobile-add-target">
                        <i class="fas fa-plus"></i>
                        <span>Add Target</span>
                    </button>
                    <button class="mobile-action-btn" id="mobile-set-date">
                        <i class="fas fa-calendar-day"></i>
                        <span>Set Date</span>
                    </button>
                    <button class="mobile-action-btn" id="mobile-view-stats">
                        <i class="fas fa-chart-bar"></i>
                        <span>View Stats</span>
                    </button>
                    <button class="mobile-action-btn" id="mobile-view-leaderboard">
                        <i class="fas fa-trophy"></i>
                        <span>Leaderboard</span>
                    </button>
                </div>
                
                <!-- Main Counter -->
                <div class="mobile-main-counter">
                    <div class="mobile-counter-title">
                        <i class="fas fa-calendar-day"></i>
                        Main Goal
                    </div>
                    <div class="mobile-counter-value" id="mobile-main-counter">14</div>
                    <div class="mobile-counter-subtitle">Days until your goal</div>
                    <div class="mobile-counter-date" id="mobile-counter-date">
                        <i class="fas fa-flag"></i>
                        <span id="mobile-counter-date-text">December 31, 2023</span>
                    </div>
                    <button class="mobile-counter-btn" id="mobile-set-date-btn">
                        <i class="fas fa-edit"></i> Set Target Date
                    </button>
                </div>
                
                <!-- Recent Targets -->
                <div class="mobile-recent-targets">
                    <div class="mobile-recent-title">
                        <span>Recent Targets</span>
                        <span id="mobile-targets-count">0 targets</span>
                    </div>
                    
                    <div id="mobile-recent-targets-list">
                        <div class="mobile-empty-targets">
                            <p>No active targets yet.</p>
                            <button class="mobile-add-target-btn" id="mobile-add-first-target">
                                <i class="fas fa-plus"></i> Add Your First Target
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Targets Section -->
        <div class="section-content" id="targets-section" style="display: none;">
            <div class="targets-section">
                <div class="section-title">
                    <h2><i class="fas fa-tasks"></i> Active Targets</h2>
                    <button class="btn" id="new-target-btn">
                        <i class="fas fa-plus"></i> New Target
                    </button>
                </div>
                <div class="targets-list" id="targets-list">
                    <div class="empty-targets">
                        <p>No active targets yet.</p>
                        <button class="btn" id="add-first-target">
                            <i class="fas fa-plus"></i> Add Your First Target
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div class="section-content" id="analytics-section" style="display: none;">
            <div class="analytics-section">
                <div class="section-title">
                    <h2><i class="fas fa-chart-bar"></i> Work Analytics</h2>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" id="refresh-analytics">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="analytics-card">
                    <h3 style="margin-bottom: 20px; color: var(--accent-light);">
                        <i class="fas fa-clock"></i> Daily Work Time (Last 7 Days)
                    </h3>
                    <div class="chart-container">
                        <canvas id="work-time-chart"></canvas>
                    </div>
                    <div class="time-details" id="time-details">
                        <h4 id="selected-day">Monday</h4>
                        <div class="time-sessions" id="time-sessions">
                            <!-- Work sessions will be listed here -->
                        </div>
                    </div>
                </div>
                <div class="analytics-card" id="focus-analytics-card" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--accent-light);">
                        <i class="fas fa-bullseye"></i> Focus Analytics (Pomodoro)
                    </h3>
                    <div style="display:flex; gap:20px; flex-wrap: wrap;">
                        <div><strong>Total Focus Time:</strong> <span id="focus-total">0m</span></div>
                        <div><strong>Sessions Completed:</strong> <span id="focus-sessions">0</span></div>
                        <div><strong>Average Session:</strong> <span id="focus-average">0m</span></div>
                        <div><strong>Longest Session:</strong> <span id="focus-longest">0m</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friends Section -->
        <div class="section-content" id="friends-section" style="display: none;">
            <div class="friends-section">
                <div class="section-title">
                    <h2><i class="fas fa-user-friends"></i> Friends</h2>
                </div>
                <div class="friends-card">
                    <div class="friends-tabs">
                        <button class="friends-tab active" data-tab="friends">My Friends</button>
                        <button class="friends-tab" data-tab="requests">Friend Requests</button>
                        <button class="friends-tab" data-tab="search">Find Friends</button>
                    </div>
                    
                    <div class="friends-content active" id="friends-tab">
                        <div class="friends-list" id="friends-list">
                            <div class="empty-targets">
                                <p>You haven't added any friends yet.</p>
                                <p>Search for friends to connect with other hunters!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="friends-content" id="requests-tab">
                        <div class="requests-list" id="requests-list">
                            <div class="empty-targets">
                                <p>No pending friend requests.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="friends-content" id="search-tab">
                        <div class="search-friends">
                            <input type="text" id="friend-search" placeholder="Search for friends by name...">
                            <button class="btn" id="search-friends-btn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div class="search-results" id="search-results">
                            <div class="empty-targets">
                                <p>Search for friends to connect with other hunters!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Leaderboard Section -->
        <div class="section-content" id="leaderboard-section" style="display: none;">
            <div class="leaderboard-section">
                <div class="section-title">
                    <h2><i class="fas fa-trophy"></i> Hunter Leaderboard</h2>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" id="refresh-leaderboard">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="leaderboard-card">
                    <div class="leaderboard-list" id="leaderboard-list">
                        <div class="empty-targets">
                            <p>Loading leaderboard...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Store Section -->
        <div class="section-content" id="store-section" style="display: none;">
            <div class="store-section">
                <div class="section-title">
                    <h2><i class="fas fa-shopping-cart"></i> Hunter Shop</h2>
                    <div class="store-balance" style="display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-coins"></i>
                        <span id="store-coins-display">0</span> Coins
                    </div>
                </div>
                <div class="store-grid" id="store-items">
                    <div class="empty-targets">
                        <p>Loading store items...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div class="section-content" id="inventory-section" style="display: none;">
            <div class="inventory-section">
                <div class="section-title">
                    <h2><i class="fas fa-box-open"></i> Inventory</h2>
                </div>
                <div class="inventory-list" id="inventory-list">
                    <div class="empty-targets">
                        <p>No items acquired yet.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div class="section-content" id="settings-section" style="display: none;">
            <div class="settings-section">
                <div class="section-title">
                    <h2><i class="fas fa-cog"></i> Settings</h2>
                </div>
                <div class="settings-card">
                    <div class="settings-group">
                        <h3><i class="fas fa-user"></i> Account Settings</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Hunter Profile</h4>
                                <p>Change your name and profile picture</p>
                            </div>
                            <button class="btn" id="change-profile-btn">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Password Reset</h4>
                                <p>Send a password reset email to your account</p>
                            </div>
                            <button class="btn" id="settings-password-reset">
                                <i class="fas fa-envelope"></i> Send Reset Email
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3><i class="fas fa-bell"></i> Notifications</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Browser Notifications</h4>
                                <p>Receive notifications in your browser</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="browser-notifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Sound Effects</h4>
                                <p>Play sounds for level ups and achievements</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sound-effects" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3><i class="fas fa-palette"></i> Appearance</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Dark Mode</h4>
                                <p>Use dark theme (always enabled)</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode" checked disabled>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Animations</h4>
                                <p>Enable UI animations and effects</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="animations" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3><i class="fas fa-shield-alt"></i> Privacy & Security</h3>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Public Profile</h4>
                                <p>Allow others to see your profile on leaderboard</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="public-profile" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-cancel" id="reset-data">
                            <i class="fas fa-trash"></i> Reset Data
                        </button>
                        <button class="btn" id="export-data">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Target Modal -->
    <div class="modal" id="target-modal">
        <div class="modal-content">
            <h2><i class="fas fa-bullseye"></i> Create New Target</h2>
            <div class="form-group">
                <label for="target-title">
                    <i class="fas fa-heading"></i> Target Title
                </label>
                <input type="text" id="target-title" class="form-control" placeholder="What do you want to achieve?">
            </div>
            <div class="form-group">
                <label for="target-xp">
                    <i class="fas fa-bolt"></i> XP Reward
                </label>
                <input type="number" id="target-xp" class="form-control" value="50" min="10" max="500">
                <small style="color: var(--text-dim); margin-top: 5px; display: block; margin-left: 32px;">
                    Higher value targets give more XP (10-500)
                </small>
            </div>
            <div class="form-group">
                <label for="target-type">
                    <i class="fas fa-scroll"></i> Quest Type
                </label>
                <select id="target-type" class="form-control">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="story">Story</option>
                    <option value="boss">Boss</option>
                </select>
            </div>
            <div class="form-group">
                <label for="target-deadline">
                    <i class="fas fa-calendar-day"></i> Deadline (Optional)
                </label>
                <input type="date" id="target-deadline" class="form-control">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-target">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" id="save-target">
                    <i class="fas fa-save"></i> Save Target
                </button>
            </div>
        </div>
    </div>

    <!-- Date Modal -->
    <div class="modal" id="date-modal">
        <div class="modal-content">
            <h2><i class="fas fa-calendar-day"></i> Set Main Day Counter</h2>
            <div class="form-group">
                <label for="main-date-title">
                    <i class="fas fa-heading"></i> Goal Title
                </label>
                <input type="text" id="main-date-title" class="form-control" placeholder="What's your main goal?">
            </div>
            <div class="form-group">
                <label for="main-target-date">
                    <i class="fas fa-calendar"></i> Target Date
                </label>
                <input type="date" id="main-target-date" class="form-control">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-date">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" id="save-date">
                    <i class="fas fa-save"></i> Save Date
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <h2><i class="fas fa-user-edit"></i> Edit Hunter Profile</h2>
            <div class="form-group">
                <label for="profile-name">
                    <i class="fas fa-user"></i> Hunter Name
                </label>
                <input type="text" id="profile-name" class="form-control" placeholder="Enter your hunter name">
            </div>
            <div class="form-group">
                <label>
                    <i class="fas fa-user-circle"></i> Profile Picture
                </label>
                <div class="avatar-selection">
                    <div class="avatar-option" data-avatar="warrior">⚔️</div>
                    <div class="avatar-option" data-avatar="mage">🧙</div>
                    <div class="avatar-option" data-avatar="archer">🏹</div>
                    <div class="avatar-option" data-avatar="knight">🛡️</div>
                    <div class="avatar-option" data-avatar="ninja">🥷</div>
                    <div class="avatar-option" data-avatar="wizard">🔮</div>
                    <div class="avatar-option" data-avatar="berserker">⚡</div>
                    <div class="avatar-option" data-avatar="assassin">🗡️</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-profile">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" id="save-profile">
                    <i class="fas fa-save"></i> Save Profile
                </button>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen Timer -->
    <div class="fullscreen-timer" id="fullscreen-timer">
        <div class="fullscreen-timer-content">
            <h2 id="fullscreen-task-title">Task Timer</h2>
            <div class="fullscreen-timer-display" id="fullscreen-timer-display">00:00:00</div>
            <div class="fullscreen-timer-controls">
                <button class="timer-btn start" id="fs-start">
                    <i class="fas fa-play"></i> Start
                </button>
                <button class="timer-btn pause" id="fs-pause">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="timer-btn reset" id="fs-reset">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button class="timer-btn" id="fs-close">
                    <i class="fas fa-times"></i> Exit
                </button>
            </div>
        </div>
    </div>

    <!-- Focus Mode Overlay (Game-like RPG Interface) -->
    <div class="focus-overlay" id="focus-overlay" style="display: none;">
        <div class="focus-game-container">
            <!-- Game Header -->
            <div class="focus-game-header">
                <div class="hunter-status">
                    <div class="hunter-avatar">
                        <i class="fas fa-user-ninja"></i>
                    </div>
                    <div class="hunter-info">
                        <div class="hunter-name">Shadow Hunter</div>
                        <div class="hunter-level">Level <span id="focus-level">1</span></div>
                    </div>
                </div>
                <div class="focus-stats">
                    <div class="stat-bar">
                        <div class="stat-label">
                            <i class="fas fa-heart"></i> Focus Energy
                        </div>
                        <div class="stat-bar-container">
                            <div class="stat-bar-fill focus-energy" id="focus-energy-bar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <i class="fas fa-star"></i> XP Progress
                        </div>
                        <div class="stat-bar-container">
                            <div class="stat-bar-fill xp-progress" id="xp-progress-bar" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Main Area -->
            <div class="focus-game-main">
                <div class="quest-panel">
                    <h3><i class="fas fa-scroll"></i> Current Quest</h3>
                    <div class="quest-phases" id="pomodoro-phases">
                        <div class="phase-indicator active" data-phase="focus">
                            <i class="fas fa-sword"></i>
                            <span>Battle Focus</span>
                        </div>
                        <div class="phase-indicator" data-phase="shortBreak">
                            <i class="fas fa-shield-alt"></i>
                            <span>Rest</span>
                        </div>
                        <div class="phase-indicator" data-phase="longBreak">
                            <i class="fas fa-home"></i>
                            <span>Recovery</span>
                        </div>
                    </div>
                </div>

                <div class="timer-arena">
                    <div class="arena-background">
                        <div class="floating-particles"></div>
                    </div>
                    <div class="timer-crystal">
                        <div class="crystal-glow"></div>
                        <svg class="progress-ring" width="160" height="160">
                            <circle class="progress-ring__circle" id="progress-ring-circle" r="72" cx="80" cy="80" />
                        </svg>
                        <div class="focus-time" id="focus-time">25:00</div>
                        <div id="focus-message" class="focus-message" style="margin-top:8px; color:var(--text-dim);">Ready to focus</div>
                        <div class="crystal-runes">
                            <span class="rune">⚡</span>
                            <span class="rune">🔥</span>
                            <span class="rune">❄️</span>
                            <span class="rune">🌟</span>
                        </div>
                    </div>
                </div>

                <div class="focus-task-ui" style="margin: 16px 0; text-align: center;">
                    <label for="focus-task-select" style="margin-right: 8px; color: var(--text-dim);"><i class="fas fa-scroll"></i> Quest task</label>
                    <select id="focus-task-select" style="padding:8px; border-radius:8px; min-width: 180px;"></select>
                    <input id="focus-quick-label" type="text" placeholder="Or quick task name" style="margin-left:8px; padding:8px; border-radius:8px; min-width: 200px;" />
                </div>

                <div class="game-controls">
                    <button class="game-btn start-quest" id="pomodoro-start">
                        <i class="fas fa-play"></i>
                        <span>Begin Quest</span>
                    </button>
                    <button class="game-btn pause-quest" id="pomodoro-pause">
                        <i class="fas fa-pause"></i>
                        <span>Pause</span>
                    </button>
                    <button class="game-btn reset-quest" id="pomodoro-reset">
                        <i class="fas fa-undo"></i>
                        <span>Reset</span>
                    </button>
                    <button class="game-btn exit-quest" id="pomodoro-close">
                        <i class="fas fa-door-open"></i>
                        <span>Exit Arena</span>
                    </button>
                </div>
            </div>

            <!-- Game Footer -->
            <div class="focus-game-footer">
                <div class="achievement-preview">
                    <i class="fas fa-trophy"></i>
                    <span>Next: Focus Warrior (Complete 5 sessions)</span>
                </div>
                <div class="session-counter">
                    <i class="fas fa-fire"></i>
                    <span>Streak: <span id="focus-streak">0</span></span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-bell" id="notification-icon"></i>
        <div>
            <h4 id="notification-title">Target Completed!</h4>
            <p id="notification-message">You've earned 50 XP!</p>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div class="modal" id="purchase-modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" id="close-purchase-modal" aria-label="Close" style="position:absolute; right:12px; top:12px; background:none; border:none; color:var(--text); font-size:24px; cursor:pointer;">&times;</button>
            <h2><i class="fas fa-shopping-bag"></i> Confirm Purchase</h2>
            <p id="purchase-message">Are you sure you want to buy this item?</p>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancel-purchase">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" id="confirm-purchase">
                    <i class="fas fa-check"></i> Buy
                </button>
            </div>
        </div>
    </div>
    
    <div class="level-up" id="level-up">
        <div class="level-up-content">
            <h2>LEVEL UP!</h2>
            <p>You've reached level <span id="new-level">2</span>!</p>
            <button class="btn" id="close-level-up">
                <i class="fas fa-arrow-right"></i> Continue
            </button>
        </div>
    </div>

    <div class="achievement-badge" id="achievement-badge">
        <div class="achievement-icon">🏆</div>
        <div class="achievement-text">
            <h4 id="achievement-title">First Target!</h4>
            <p id="achievement-desc">Completed your first target</p>
        </div>
    </div>

    <div class="sync-status" id="sync-status">
        <i class="fas fa-cloud" id="sync-icon"></i>
        <span id="sync-text">Synced</span>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAR5GeVg0GGkyT6ntO-ExQ8UN6koC2NvEs",
            authDomain: "solo-leveling-ef031.firebaseapp.com",
            databaseURL: "https://solo-leveling-ef031-default-rtdb.firebaseio.com",
            projectId: "solo-leveling-ef031",
            storageBucket: "solo-leveling-ef031.firebasestorage.app",
            messagingSenderId: "197644781407",
            appId: "1:197644781407:web:1f22963376852ab0db18ea",
            measurementId: "G-RVC95K5EDZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // App state
        const state = {
            level: 1,
            currentXP: 0,
            totalXP: 0,
            totalTargets: 0,
            completedTargets: 0,
            targets: [],
            achievements: {
                firstTarget: false,
                level5: false,
                level10: false
            },
            user: {
                name: "",
                profilePic: "",
                userId: "",
                email: "",
                publicProfile: true,
                selectedAvatar: "warrior"
            },
            // Store & Inventory
            coins: 0,
            xpBoost: 1,
            storeItems: [],
            inventory: [],
            mainCounter: {
                title: "Project Deadline",
                date: "2023-12-31",
                daysLeft: 14
            },
            settings: {
                notifications: true,
                soundEffects: true,
                animations: true,
                browserNotifications: true
            },
            pomodoro: { cycles: 4, focusDuration: 25 * 60, shortBreak: 5 * 60, longBreak: 15 * 60, currentCycle: 0, phase: 'idle', remaining: 25 * 60, running: false, intervalId: null, selectedTargetId: null, quickLabel: '' },
            activeTimers: {},
            leaderboard: [],
            activityLog: [],
            workSessions: {},
            friends: {},
            friendRequests: {},
            pendingRequests: {}
        };

        // Avatar options mapping
        const avatarOptions = {
            warrior: "⚔️",
            mage: "🧙",
            archer: "🏹",
            knight: "🛡️",
            ninja: "🥷",
            wizard: "🔮",
            berserker: "⚡",
            assassin: "🗡️"
        };

        // DOM elements
        const elements = {
            // Authentication
            authModal: document.getElementById('auth-modal'),
            loginTabs: document.querySelectorAll('.login-tab'),
            loginForms: document.querySelectorAll('.login-form'),
            signinForm: document.getElementById('signin-form'),
            signupForm: document.getElementById('signup-form'),
            signinEmail: document.getElementById('signin-email'),
            signinPassword: document.getElementById('signin-password'),
            signinEmailBtn: document.getElementById('signin-email-btn'),
            signinError: document.getElementById('signin-error'),
            signupName: document.getElementById('signup-name'),
            signupEmail: document.getElementById('signup-email'),
            signupPassword: document.getElementById('signup-password'),
            signupEmailBtn: document.getElementById('signup-email-btn'),
            signupError: document.getElementById('signup-error'),
            googleSignin: document.getElementById('google-signin'),
            googleSignup: document.getElementById('google-signup'),
            
            // Main UI
            mainContainer: document.getElementById('main-container'),
            userAvatar: document.getElementById('user-avatar'),
            userAvatarImg: document.getElementById('user-avatar-img'),
            userAvatarText: document.getElementById('user-avatar-text'),
            userNameDisplay: document.getElementById('user-name-display'),
            userLevel: document.getElementById('user-level'),
            userProfile: document.getElementById('user-profile'),
            userTargets: document.getElementById('user-targets'),
            userCompleted: document.getElementById('user-completed'),
            userDays: document.getElementById('user-days'),
            logoutBtn: document.getElementById('logout-btn'),
            soundToggle: document.getElementById('sound-toggle'),
            soundToggleIcon: document.getElementById('sound-toggle-icon'),
                        soundToggleLabel: document.getElementById('sound-toggle-label'),
            focusModeBtn: document.getElementById('focus-mode-btn'),
            focusOverlay: document.getElementById('focus-overlay'),
            focusTime: document.getElementById('focus-time'),
            focusMessage: document.getElementById('focus-message'),
            focusEnergyBar: document.getElementById('focus-energy-bar'),
            xpProgressBar: document.getElementById('xp-progress-bar'),
            progressRingCircle: document.getElementById('progress-ring-circle'),
            pomodoroPhases: document.getElementById('pomodoro-phases'),
            pomodoroStart: document.getElementById('pomodoro-start'),
            pomodoroPause: document.getElementById('pomodoro-pause'),
            pomodoroReset: document.getElementById('pomodoro-reset'),
            pomodoroClose: document.getElementById('pomodoro-close'),
            focusTaskSelect: document.getElementById('focus-task-select'),
            focusQuickLabel: document.getElementById('focus-quick-label'),
            
            // Navigation
            navBtns: document.querySelectorAll('.nav-btn'),
            sectionContents: document.querySelectorAll('.section-content'),
            
            // Dashboard
            currentLevel: document.getElementById('current-level'),
            xpText: document.getElementById('xp-text'),
            xpBar: document.getElementById('xp-bar'),
            xpDetails: document.getElementById('xp-details'),
            totalTargets: document.getElementById('total-targets'),
            completedTargets: document.getElementById('completed-targets'),
            dayCounter: document.getElementById('day-counter'),
            totalXp: document.getElementById('total-xp'),
            mainCounter: document.getElementById('main-counter'),
            counterDateText: document.getElementById('counter-date-text'),
            dayCounterCard: document.getElementById('day-counter-card'),
            setDateBtn: document.getElementById('set-date-btn'),
            
            // Mobile Dashboard - REDESIGNED
            mobileUserAvatar: document.getElementById('mobile-user-avatar'),
            mobileUserAvatarImg: document.getElementById('mobile-user-avatar-img'),
            mobileUserAvatarText: document.getElementById('mobile-user-avatar-text'),
            mobileUserName: document.getElementById('mobile-user-name'),
            mobileUserLevel: document.getElementById('mobile-user-level'),
            mobileLevel: document.getElementById('mobile-level'),
            mobileTotalTargets: document.getElementById('mobile-total-targets'),
            mobileCompletedTargets: document.getElementById('mobile-completed-targets'),
            mobileTotalXp: document.getElementById('mobile-total-xp'),
            mobileDaysLeft: document.getElementById('mobile-days-left'),
            mobileXpProgress: document.getElementById('mobile-xp-progress'),
            mobileXpBar: document.getElementById('mobile-xp-bar'),
            mobileCurrentLevel: document.getElementById('mobile-current-level'),
            mobileNextLevel: document.getElementById('mobile-next-level'),
            mobileAddTarget: document.getElementById('mobile-add-target'),
            mobileSetDate: document.getElementById('mobile-set-date'),
            mobileViewStats: document.getElementById('mobile-view-stats'),
            mobileViewLeaderboard: document.getElementById('mobile-view-leaderboard'),
            mobileMainCounter: document.getElementById('mobile-main-counter'),
            mobileCounterDate: document.getElementById('mobile-counter-date'),
            mobileCounterDateText: document.getElementById('mobile-counter-date-text'),
            mobileSetDateBtn: document.getElementById('mobile-set-date-btn'),
            mobileRecentTargetsList: document.getElementById('mobile-recent-targets-list'),
            mobileTargetsCount: document.getElementById('mobile-targets-count'),
            mobileAddFirstTarget: document.getElementById('mobile-add-first-target'),
            
            // Targets
            targetsList: document.getElementById('targets-list'),
            newTargetBtn: document.getElementById('new-target-btn'),
            addFirstTarget: document.getElementById('add-first-target'),
            targetModal: document.getElementById('target-modal'),
            targetTitle: document.getElementById('target-title'),
            targetXp: document.getElementById('target-xp'),
            targetDeadline: document.getElementById('target-deadline'),
            targetType: document.getElementById('target-type'),
            cancelTarget: document.getElementById('cancel-target'),
            saveTarget: document.getElementById('save-target'),
            
            // Analytics
            workTimeChart: document.getElementById('work-time-chart'),
            timeDetails: document.getElementById('time-details'),
            selectedDay: document.getElementById('selected-day'),
            timeSessions: document.getElementById('time-sessions'),
            refreshAnalytics: document.getElementById('refresh-analytics'),
            
            // Friends
            friendsTabs: document.querySelectorAll('.friends-tab'),
            friendsContents: document.querySelectorAll('.friends-content'),
            friendsList: document.getElementById('friends-list'),
            requestsList: document.getElementById('requests-list'),
            friendSearch: document.getElementById('friend-search'),
            searchFriendsBtn: document.getElementById('search-friends-btn'),
            searchResults: document.getElementById('search-results'),
            
            // Leaderboard
            leaderboardList: document.getElementById('leaderboard-list'),
            refreshLeaderboard: document.getElementById('refresh-leaderboard'),
            
            // Settings
            changeProfileBtn: document.getElementById('change-profile-btn'),
            browserNotifications: document.getElementById('browser-notifications'),
            soundEffects: document.getElementById('sound-effects'),
            animations: document.getElementById('animations'),
            publicProfile: document.getElementById('public-profile'),
            resetData: document.getElementById('reset-data'),
            exportData: document.getElementById('export-data'),
            
            // Profile Modal
            profileModal: document.getElementById('profile-modal'),
            profileName: document.getElementById('profile-name'),
            cancelProfile: document.getElementById('cancel-profile'),
            saveProfile: document.getElementById('save-profile'),
            avatarOptions: document.querySelectorAll('.avatar-option'),
            
            // Date Modal
            dateModal: document.getElementById('date-modal'),
            mainDateTitle: document.getElementById('main-date-title'),
            mainTargetDate: document.getElementById('main-target-date'),
            cancelDate: document.getElementById('cancel-date'),
            saveDate: document.getElementById('save-date'),
            
            // Fullscreen Timer
            fullscreenTimer: document.getElementById('fullscreen-timer'),
            fullscreenTaskTitle: document.getElementById('fullscreen-task-title'),
            fullscreenTimerDisplay: document.getElementById('fullscreen-timer-display'),
            fsStart: document.getElementById('fs-start'),
            fsPause: document.getElementById('fs-pause'),
            fsReset: document.getElementById('fs-reset'),
            fsClose: document.getElementById('fs-close'),
            
            // Notifications & Status
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            notificationIcon: document.getElementById('notification-icon'),
            levelUp: document.getElementById('level-up'),
            newLevel: document.getElementById('new-level'),
            closeLevelUp: document.getElementById('close-level-up'),
            achievementBadge: document.getElementById('achievement-badge'),
            achievementTitle: document.getElementById('achievement-title'),
            achievementDesc: document.getElementById('achievement-desc'),
            loading: document.getElementById('loading'),
            syncStatus: document.getElementById('sync-status'),
            syncIcon: document.getElementById('sync-icon'),
            syncText: document.getElementById('sync-text'),
            particlesContainer: document.getElementById('particles-container')
        };

        // Store & Inventory elements
        elements.storeCoinsDisplay = document.getElementById('store-coins-display');
        elements.storeItems = document.getElementById('store-items');
        elements.inventoryList = document.getElementById('inventory-list');
        elements.purchaseModal = document.getElementById('purchase-modal');
        elements.closePurchaseModal = document.getElementById('close-purchase-modal');
        elements.cancelPurchase = document.getElementById('cancel-purchase');
        elements.confirmPurchase = document.getElementById('confirm-purchase');

        // Lightweight Sound Manager using Web Audio API
        const sound = (function createSoundManager() {
            let ctx = null;
            let master = null;
            let initialized = false;
        function init() {
                if (initialized) return;
                try {
                    ctx = new (window.AudioContext || window.webkitAudioContext)();
                    master = ctx.createGain();
                    master.gain.value = 0.12;
                    master.connect(ctx.destination);
                    initialized = true;
                } catch (e) {
                    // Audio not available; ignore
                }
            }
            function playTone(freq, duration = 120, type = 'sine', volume = 0.15, when = 0) {
                if (!state.settings.soundEffects) return;
                if (!ctx) init();
                if (!ctx) return;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime + when);
                gain.gain.setValueAtTime(0.0001, ctx.currentTime + when);
                gain.gain.linearRampToValueAtTime(volume, ctx.currentTime + when + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + when + duration / 1000);
                osc.connect(gain);
                gain.connect(master);
                osc.start(ctx.currentTime + when);
                osc.stop(ctx.currentTime + when + duration / 1000 + 0.02);
            }
            function play(name) {
                switch (name) {
                    case 'ui':
                        playTone(500, 70, 'sine', 0.12); break;
                    case 'start':
                        playTone(620, 100, 'square', 0.12); break;
                    case 'pause':
                        playTone(360, 100, 'square', 0.12); break;
                    case 'reset':
                        playTone(280, 140, 'triangle', 0.12); break;
                    case 'notification':
                        playTone(880, 70, 'sine', 0.15); playTone(660, 70, 'sine', 0.13, 0.08); break;
                    case 'success':
                        playTone(440, 120, 'triangle', 0.15); playTone(660, 120, 'triangle', 0.15, 0.14); playTone(880, 160, 'triangle', 0.15, 0.30); break;
                    case 'achievement':
                        playTone(500, 120, 'sine', 0.13); playTone(700, 120, 'sine', 0.13, 0.14); playTone(900, 160, 'sine', 0.13, 0.30); break;
                    case 'levelup':
                        playTone(523.25, 160, 'square', 0.15); playTone(659.25, 160, 'square', 0.15, 0.18); playTone(783.99, 220, 'square', 0.16, 0.38); playTone(1046.50, 280, 'square', 0.18, 0.65); break;
                }
            }
            function setEnabled(enabled) {
                state.settings.soundEffects = !!enabled;
                if (!ctx) init();
                if (master) {
                    master.gain.value = enabled ? 0.12 : 0.0;
                }
                updateSoundToggleUI();
            }
            return { init, play, setEnabled };
        })();

        function updateSoundToggleUI() {
            const enabled = !!state.settings.soundEffects;
            if (elements.soundToggleIcon) {
                elements.soundToggleIcon.className = enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            }
            if (elements.soundToggleLabel) {
                elements.soundToggleLabel.textContent = enabled ? 'Sound On' : 'Sound Off';
            }
            if (elements.soundToggle) {
                elements.soundToggle.classList.toggle('muted', !enabled);
            }
            if (elements.soundEffects) {
                elements.soundEffects.checked = enabled;
            }
        }

        function toggleSound() {
            state.settings.soundEffects = !state.settings.soundEffects;
            sound.setEnabled(state.settings.soundEffects);
            saveState();
            if (state.settings.soundEffects) sound.play('ui');
        }

        // Format time for display
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Format time for display (hours and minutes)
        function formatTimeShort(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hrs}h ${mins}m`;
        }

        // Update timer for a specific target
        function updateTimer(targetId) {
            const target = state.targets.find(t => t.id === targetId);
            if (!target || !state.activeTimers[targetId]) return;
            
            const timer = state.activeTimers[targetId];
            if (timer.running) {
                timer.seconds++;
                target.timeSpent = timer.seconds;
                
                // Update UI
                const timerDisplay = document.querySelector(`.target-item[data-id="${targetId}"] .timer-display`);
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(timer.seconds);
                }
                
                // Update fullscreen timer if active
                if (elements.fullscreenTimer.classList.contains('active') && 
                    elements.fullscreenTimer.dataset.targetId === targetId) {
                    elements.fullscreenTimerDisplay.textContent = formatTime(timer.seconds);
                }
                
                // Auto-save every 30 seconds
                if (timer.seconds % 30 === 0) {
                    saveState();
                }
            }
        }

        // Record work session for analytics
        function recordWorkSession(targetId, options = {}) {
            const now = new Date();
            const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const currentTime = now.toTimeString().split(' ')[0]; // HH:MM:SS
            const source = options.source || null;
            const linkedTargetId = options.linkedTargetId || null;
            const quickLabel = (options.quickLabel || '').trim();
            
            // Initialize today's sessions if not exists
            if (!state.workSessions[today]) {
                state.workSessions[today] = [];
            }
            
            // Check if we're already recording a session for this target
            const activeSessionIndex = state.workSessions[today].findIndex(
                session => session.targetId === targetId && !session.end
            );
            
            if (activeSessionIndex === -1) {
                // Start new session
                state.workSessions[today].push({
                    targetId: targetId,
                    start: currentTime,
                    end: null,
                    source: source,
                    linkedTargetId: linkedTargetId,
                    quickLabel: quickLabel
                });
            } else {
                // Update existing session
                state.workSessions[today][activeSessionIndex].end = currentTime;
            }
        }

        // Start timer for a target
        function startTimer(targetId) {
            const target = state.targets.find(t => t.id === targetId);
            if (!target) return;
            
            // Initialize timer if not exists
            if (!state.activeTimers[targetId]) {
                state.activeTimers[targetId] = {
                    seconds: target.timeSpent || 0,
                    running: true,
                    interval: null
                };
            }
            
            const timer = state.activeTimers[targetId];
            timer.running = true;
            sound.play('start');
            
            // Start interval if not already running
            if (!timer.interval) {
                timer.interval = setInterval(() => updateTimer(targetId), 1000);
            }
            
            // Update UI
            const startBtn = document.querySelector(`.target-item[data-id="${targetId}"] .timer-btn.start`);
            const pauseBtn = document.querySelector(`.target-item[data-id="${targetId}"] .timer-btn.pause`);
            
            if (startBtn) startBtn.classList.add('hidden');
            if (pauseBtn) pauseBtn.classList.remove('hidden');
            
            // Update fullscreen timer if active
            if (elements.fullscreenTimer.classList.contains('active') && 
                elements.fullscreenTimer.dataset.targetId === targetId) {
                elements.fsStart.classList.add('hidden');
                elements.fsPause.classList.remove('hidden');
            }
            
            // Record work session start
            recordWorkSession(targetId);
        }

        // Pause timer for a target
        function pauseTimer(targetId) {
            const timer = state.activeTimers[targetId];
            if (!timer) return;
            
            timer.running = false;
            sound.play('pause');
            
            // Update UI
            const startBtn = document.querySelector(`.target-item[data-id="${targetId}"] .timer-btn.start`);
            const pauseBtn = document.querySelector(`.target-item[data-id="${targetId}"] .timer-btn.pause`);
            
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
            
            // Update fullscreen timer if active
            if (elements.fullscreenTimer.classList.contains('active') && 
                elements.fullscreenTimer.dataset.targetId === targetId) {
                elements.fsStart.classList.remove('hidden');
                elements.fsPause.classList.add('hidden');
            }
            
            // Record work session end
            recordWorkSession(targetId);
        }

        // Reset timer for a target
        function resetTimer(targetId) {
            const timer = state.activeTimers[targetId];
            if (timer) {
                clearInterval(timer.interval);
                delete state.activeTimers[targetId];
            }
            
            const target = state.targets.find(t => t.id === targetId);
            if (target) {
                target.timeSpent = 0;
            }
            
            // Update UI
            const timerDisplay = document.querySelector(`.target-item[data-id="${targetId}"] .timer-display`);
            const startBtn = document.querySelector(`.target-item[data-id="${targetId}"] .timer-btn.start`);
            const pauseBtn = document.querySelector(`.target-item[data-id="${targetId}"] .timer-btn.pause`);
            
            if (timerDisplay) timerDisplay.textContent = '00:00:00';
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
            
            // Update fullscreen timer if active
            if (elements.fullscreenTimer.classList.contains('active') && 
                elements.fullscreenTimer.dataset.targetId === targetId) {
                elements.fullscreenTimerDisplay.textContent = '00:00:00';
                elements.fsStart.classList.remove('hidden');
                elements.fsPause.classList.add('hidden');
            }
            
            sound.play('reset');
            saveState();
        }

        // Open fullscreen timer
        function openFullscreenTimer(targetId) {
            const target = state.targets.find(t => t.id === targetId);
            if (!target) return;
            
            elements.fullscreenTimer.dataset.targetId = targetId;
            elements.fullscreenTaskTitle.textContent = target.title;
            
            const timer = state.activeTimers[targetId];
            const seconds = timer ? timer.seconds : (target.timeSpent || 0);
            elements.fullscreenTimerDisplay.textContent = formatTime(seconds);
            
            // Update button states
            const isRunning = timer && timer.running;
            elements.fsStart.classList.toggle('hidden', !!isRunning);
            elements.fsPause.classList.toggle('hidden', !isRunning);
            
            elements.fullscreenTimer.classList.add('active');
            sound.play('ui');
        }

        // Close fullscreen timer
        function closeFullscreenTimer() {
            elements.fullscreenTimer.classList.remove('active');
            sound.play('ui');
        }

        // Focus Mode (Pomodoro) Manager
        function formatMMSS(totalSeconds) {
            const m = Math.floor(totalSeconds / 60);
            const s = Math.max(0, totalSeconds % 60);
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updatePomodoroPhaseIndicators() {
            const container = elements.pomodoroPhases;
            if (!container) return;
            const phase = state.pomodoro.phase;
            const indicators = container.querySelectorAll('.phase-indicator');
            indicators.forEach(ind => {
                const p = ind.getAttribute('data-phase');
                ind.classList.remove('active', 'completed');
                if (phase === 'idle') return;
                if (p === 'focus' && phase === 'focus') ind.classList.add('active');
                if (p === 'shortBreak' && phase === 'shortBreak') ind.classList.add('active');
                if (p === 'longBreak' && phase === 'longBreak') ind.classList.add('active');
                // Mark completed cycles visually (optional, basic cue)
                if (p === 'focus' && state.pomodoro.currentCycle > 0 && phase !== 'focus') ind.classList.add('completed');
            });
        }

        function updatePomodoroUI() {
            // Update time display
            if (elements.focusTime) {
                elements.focusTime.textContent = formatMMSS(state.pomodoro.remaining);
            }
            // Update circular progress ring
            if (elements.progressRingCircle) {
                const circle = elements.progressRingCircle;
                const r = circle.r.baseVal.value;
                const circumference = 2 * Math.PI * r;
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                const phase = state.pomodoro.phase;
                let total = state.pomodoro.focusDuration;
                let strokeColor = '#FFD700';
                if (phase === 'shortBreak') { total = state.pomodoro.shortBreak; strokeColor = '#00e0c6'; }
                if (phase === 'longBreak') { total = state.pomodoro.longBreak; strokeColor = '#8e2de2'; }
                const progress = Math.min(1, Math.max(0, 1 - (state.pomodoro.remaining / total)));
                const offset = circumference - progress * circumference;
                circle.style.strokeDashoffset = offset;
                circle.style.stroke = strokeColor;
            }
            // Update energy bar (visual only)
            if (elements.focusEnergyBar) {
                const phase = state.pomodoro.phase;
                let total = state.pomodoro.focusDuration;
                if (phase === 'shortBreak') total = state.pomodoro.shortBreak;
                if (phase === 'longBreak') total = state.pomodoro.longBreak;
                let percent = 100;
                if (phase === 'focus') {
                    percent = Math.max(0, Math.round(100 * (state.pomodoro.remaining / state.pomodoro.focusDuration)));
                } else if (phase === 'shortBreak' || phase === 'longBreak') {
                    percent = Math.min(100, Math.round(100 * (1 - (state.pomodoro.remaining / total))));
                }
                elements.focusEnergyBar.style.width = `${percent}%`;
            }
            // Update focus header level and message
            const lvlEl = document.getElementById('focus-level');
            if (lvlEl) { lvlEl.textContent = state.level; }
            if (elements.focusMessage) {
                const selId = state.pomodoro.selectedTargetId;
                const target = (state.targets || []).find(t => t.id === selId);
                const label = state.pomodoro.quickLabel || (target ? target.title : '');
                const phase = state.pomodoro.phase;
                let msg = '';
                if (phase === 'focus') msg = label ? `Focusing: ${label}` : 'Focusing';
                else if (phase === 'shortBreak' || phase === 'longBreak') msg = 'Recovering energy...';
                else msg = 'Ready to focus';
                elements.focusMessage.textContent = msg;
            }
            updatePomodoroPhaseIndicators();
        }

        function openFocusOverlay() {
            if (elements.focusOverlay) {
                elements.focusOverlay.style.display = 'flex';
            }
            document.body.style.overflow = 'hidden';
            let justEnteredFocus = false;
            if (state.pomodoro.phase === 'idle') {
                state.pomodoro.phase = 'focus';
                state.pomodoro.remaining = state.pomodoro.focusDuration;
                justEnteredFocus = true;
            }
            // Update avatar in focus header if available
            const avatarEmoji = (typeof avatarOptions !== 'undefined' && state.user && state.user.selectedAvatar)
                ? avatarOptions[state.user.selectedAvatar]
                : '';
            const avatarEl = document.querySelector('.hunter-avatar');
            if (avatarEl && avatarEmoji) { avatarEl.textContent = avatarEmoji; }
            
            // Populate focus task selector and quick label
            if (elements.focusTaskSelect) {
                const sel = elements.focusTaskSelect;
                sel.innerHTML = '';
                const noneOpt = document.createElement('option');
                noneOpt.value = '';
                noneOpt.textContent = 'No specific target';
                sel.appendChild(noneOpt);
                (state.targets || []).forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.title;
                    sel.appendChild(opt);
                });
                sel.value = state.pomodoro.selectedTargetId || '';
            }
            if (elements.focusQuickLabel) {
                elements.focusQuickLabel.value = state.pomodoro.quickLabel || '';
            }
            
            updatePomodoroUI();
            sound.play(justEnteredFocus ? 'start' : 'ui');
        }

        function handlePomodoroPhaseComplete() {
            const { phase } = state.pomodoro;
            if (phase === 'focus') {
                // Record session end
                recordWorkSession('pomodoro', { source: 'pomodoro', linkedTargetId: state.pomodoro.selectedTargetId || null, quickLabel: state.pomodoro.quickLabel || '' });
                state.pomodoro.currentCycle = (state.pomodoro.currentCycle || 0) + 1;
                const isLong = state.pomodoro.currentCycle % state.pomodoro.cycles === 0;
                state.pomodoro.phase = isLong ? 'longBreak' : 'shortBreak';
                state.pomodoro.remaining = isLong ? state.pomodoro.longBreak : state.pomodoro.shortBreak;
                if (elements.xpProgressBar) { elements.xpProgressBar.style.width = '100%'; }
                sound.play('success');
                showNotification('Focus Complete', 'Time for a break!', 'fas fa-coffee');
            } else if (phase === 'shortBreak' || phase === 'longBreak') {
                state.pomodoro.phase = 'focus';
                state.pomodoro.remaining = state.pomodoro.focusDuration;
                showNotification('Break Over', 'Back to focus!', 'fas fa-bullseye');
            }
            updatePomodoroUI();
            updateFocusAnalyticsDisplay && updateFocusAnalyticsDisplay();
        }

        function startPomodoro() {
            // Initialize phase if idle
            if (state.pomodoro.phase === 'idle') {
                state.pomodoro.phase = 'focus';
                state.pomodoro.remaining = state.pomodoro.focusDuration;
            }
            // Start session record when entering focus
            if (state.pomodoro.phase === 'focus') {
                recordWorkSession('pomodoro', { source: 'pomodoro', linkedTargetId: state.pomodoro.selectedTargetId || null, quickLabel: state.pomodoro.quickLabel || '' });
            }
            if (state.pomodoro.running) return;
            state.pomodoro.running = true;
            if (state.pomodoro.intervalId) clearInterval(state.pomodoro.intervalId);
            state.pomodoro.intervalId = setInterval(() => {
                state.pomodoro.remaining = Math.max(0, state.pomodoro.remaining - 1);
                updatePomodoroUI();
                if (state.pomodoro.remaining <= 0) {
                    clearInterval(state.pomodoro.intervalId);
                    state.pomodoro.intervalId = null;
                    state.pomodoro.running = false;
                    handlePomodoroPhaseComplete();
                }
            }, 1000);
            if (elements.xpProgressBar) { elements.xpProgressBar.style.width = '0%'; }
            sound.play('start');
        }

        function pausePomodoro() {
            if (state.pomodoro.intervalId) {
                clearInterval(state.pomodoro.intervalId);
                state.pomodoro.intervalId = null;
            }
            state.pomodoro.running = false;
            updatePomodoroUI();
            sound.play('pause');
        }

        function resetPomodoro() {
            if (state.pomodoro.intervalId) {
                clearInterval(state.pomodoro.intervalId);
                state.pomodoro.intervalId = null;
            }
            state.pomodoro.running = false;
            state.pomodoro.phase = 'idle';
            state.pomodoro.currentCycle = 0;
            state.pomodoro.remaining = state.pomodoro.focusDuration;
            updatePomodoroUI();
            updateFocusAnalyticsDisplay && updateFocusAnalyticsDisplay();
            sound.play('reset');
        }

        function closeFocusOverlay() {
            pausePomodoro();
            if (elements.focusOverlay) {
                elements.focusOverlay.style.display = 'none';
            }
            document.body.style.overflow = '';
            sound.play('ui');
        }

        // Create floating particles (optimized)
        function createParticles() {
            // Reduced particle count for better performance
            for (let i = 0; i < 40; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 15}s`;
                particle.style.width = `${Math.random() * 4 + 2}px`;
                particle.style.height = particle.style.width;
                elements.particlesContainer.appendChild(particle);
            }
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#4a00e0', '#8e2de2', '#00ff88', '#ff0080', '#ffff00'];
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 5}s`;
                confetti.style.width = `${Math.random() * 12 + 6}px`;
                confetti.style.height = `${Math.random() * 12 + 6}px`;
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        // Update sync status
        function updateSyncStatus(status, message) {
            elements.syncStatus.className = 'sync-status ' + status;
            elements.syncIcon.className = status === 'syncing' ? 'fas fa-sync fa-spin' : 
                                          status === 'error' ? 'fas fa-exclamation-triangle' : 
                                          'fas fa-cloud';
            elements.syncText.textContent = message;
        }

        // Save state to Firebase
        function saveState() {
            updateSyncStatus('syncing', 'Saving...');
            
            const user = auth.currentUser;
            if (user) {
                database.ref('users/' + user.uid).set(state)
                    .then(() => {
                        updateSyncStatus('synced', 'Synced');
                        
                        setTimeout(() => {
                            if (elements.syncStatus.className.includes('synced')) {
                                updateSyncStatus('synced', 'Synced');
                            }
                        }, 3000);
                    })
                    .catch((error) => {
                        console.error('Error saving to Firebase:', error);
                        updateSyncStatus('error', 'Sync failed');
                    });
            }
        }

        // Load state from Firebase
        function loadState() {
            updateSyncStatus('syncing', 'Loading...');
            
            const user = auth.currentUser;
            if (user) {
                database.ref('users/' + user.uid).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            
                            // Preserve active timers
                            const currentTimers = { ...state.activeTimers };
                            
                            // Update state with loaded data
                            Object.assign(state, data);
                            
                            // Restore active timers
                            state.activeTimers = currentTimers;
                            
                            updateSyncStatus('synced', 'Data loaded');
                        } else {
                            // Initialize new user data
                            state.user.userId = user.uid;
                            state.user.name = user.displayName || "Hunter";
                            state.user.email = user.email || "";
                            state.user.profilePic = user.photoURL || "";
                            saveState();
                            updateSyncStatus('synced', 'New profile created');
                        }
                        
                        updateUI();
                    })
                    .catch((error) => {
                        console.error('Error loading from Firebase:', error);
                        updateSyncStatus('error', 'Load failed');
                    });
            }
        }

        // Update main day counter
        function updateMainCounter() {
            if (!state.mainCounter || !state.mainCounter.date) return;
            
            const targetDate = new Date(state.mainCounter.date);
            const today = new Date();
            const timeDiff = targetDate.getTime() - today.getTime();
            const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            state.mainCounter.daysLeft = daysLeft;
            
            if (daysLeft >= 0) {
                elements.mainCounter.textContent = daysLeft;
                elements.dayCounter.textContent = daysLeft;
                elements.userDays.textContent = daysLeft;
                elements.counterDateText.textContent = `${state.mainCounter.title}: ${formatDate(state.mainCounter.date)}`;
                
                // Update mobile counter
                elements.mobileMainCounter.textContent = daysLeft;
                elements.mobileDaysLeft.textContent = daysLeft;
                elements.mobileCounterDateText.textContent = `${state.mainCounter.title}: ${formatDate(state.mainCounter.date)}`;
                
                if (daysLeft <= 7) {
                    elements.mainCounter.style.color = 'var(--warning)';
                    elements.mainCounter.style.textShadow = '0 0 25px rgba(255, 170, 0, 0.9)';
                    elements.mobileMainCounter.style.color = 'var(--warning)';
                    elements.mobileMainCounter.style.textShadow = '0 0 20px rgba(255, 170, 0, 0.9)';
                } else if (daysLeft <= 3) {
                    elements.mainCounter.style.color = 'var(--danger)';
                    elements.mainCounter.style.textShadow = '0 0 25px rgba(255, 56, 96, 0.9)';
                    elements.mobileMainCounter.style.color = 'var(--danger)';
                    elements.mobileMainCounter.style.textShadow = '0 0 20px rgba(255, 56, 96, 0.9)';
                } else {
                    elements.mainCounter.style.color = 'var(--gold)';
                    elements.mainCounter.style.textShadow = '0 0 30px rgba(255, 215, 0, 0.9)';
                    elements.mobileMainCounter.style.color = 'var(--gold)';
                    elements.mobileMainCounter.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.9)';
                }
                
                if (daysLeft === 1) {
                    showNotification("Goal Tomorrow", `${state.mainCounter.title} is due tomorrow!`, "fas fa-exclamation-triangle");
                } else if (daysLeft === 0) {
                    showNotification("Goal Today", `${state.mainCounter.title} is due today!`, "fas fa-exclamation-circle");
                }
            } else {
                elements.mainCounter.textContent = "0";
                elements.dayCounter.textContent = "0";
                elements.userDays.textContent = "0";
                elements.counterDateText.textContent = `${state.mainCounter.title} has passed`;
                elements.mainCounter.style.color = 'var(--danger)';
                elements.mainCounter.style.textShadow = '0 0 25px rgba(255, 56, 96, 0.9)';
                
                // Update mobile counter
                elements.mobileMainCounter.textContent = "0";
                elements.mobileDaysLeft.textContent = "0";
                elements.mobileCounterDateText.textContent = `${state.mainCounter.title} has passed`;
                elements.mobileMainCounter.style.color = 'var(--danger)';
                elements.mobileMainCounter.style.textShadow = '0 0 20px rgba(255, 56, 96, 0.9)';
            }
            
            saveState();
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        // Get days until deadline
        function getDaysUntilDeadline(deadline) {
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const timeDiff = deadlineDate.getTime() - now.getTime();
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        // Show notification (in-app)
        function showNotification(title, message, icon) {
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notificationIcon.className = icon;
            elements.notification.classList.add('show');
            sound.play('notification');
            
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // Show authentication modal
        function showAuthModal() {
            elements.authModal.style.display = 'flex';
        }

        // Hide authentication modal
        function hideAuthModal() {
            elements.authModal.style.display = 'none';
        }

        // Sign in with Google
        function signInWithGoogle() {
            // Check if we're in a supported environment
            if (location.protocol !== 'https:' && location.protocol !== 'http:' && location.protocol !== 'chrome-extension:') {
                showNotification('Authentication Error', 'Please open this app in a web browser with https or http protocol', 'fas fa-exclamation-triangle');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Signed in
                    const user = result.user;
                    hideAuthModal();
                    showMainUI();
                    loadState();
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    showNotification('Login Failed', errorMessage, 'fas fa-exclamation-triangle');
                });
        }

        // Sign in with Email/Password
        function signInWithEmail() {
            const email = elements.signinEmail.value;
            const password = elements.signinPassword.value;
            
            if (!email || !password) {
                showError('signin-error', 'Please enter both email and password');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    hideAuthModal();
                    showMainUI();
                    loadState();
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    showError('signin-error', errorMessage);
                });
        }

        // Sign up with Email/Password
        function signUpWithEmail() {
            const name = elements.signupName.value;
            const email = elements.signupEmail.value;
            const password = elements.signupPassword.value;
            
            if (!name || !email || !password) {
                showError('signup-error', 'Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('signup-error', 'Password must be at least 6 characters');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed up
                    const user = userCredential.user;
                    
                    // Update profile with display name
                    return user.updateProfile({
                        displayName: name
                    }).then(() => {
                        hideAuthModal();
                        showMainUI();
                        loadState();
                    });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    showError('signup-error', errorMessage);
                });
        }

        // Reset password with email
        function resetPassword(emailOverride) {
            const email = (emailOverride || (auth && auth.currentUser && auth.currentUser.email) || (elements.signinEmail && elements.signinEmail.value) || '').trim();
            
            if (!email) {
                showError('signin-error', 'Please enter your email address first or sign in');
                return;
            }
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    // Password reset email sent
                    showSuccess('reset-success', 'Password reset email sent! Check your inbox.');
                    showNotification('Password Reset Sent', `Email sent to ${email}`, 'fas fa-envelope');
                    hideError('signin-error');
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    showError('signin-error', errorMessage);
                });
        }

        // Show success message
        function showSuccess(elementId, message) {
            const successElement = document.getElementById(elementId);
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 8000);
        }

        // Hide error message
        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
        }

        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Logout user
        function logoutUser() {
            // Ensure Focus Mode closes cleanly
            try { resetPomodoro(); closeFocusOverlay(); } catch (e) {}
            // Stop all active timers
            Object.keys(state.activeTimers).forEach(targetId => {
                const timer = state.activeTimers[targetId];
                if (timer && timer.interval) {
                    clearInterval(timer.interval);
                }
            });
            
            state.activeTimers = {};
            
            auth.signOut().then(() => {
                // Reset state
                Object.keys(state).forEach(key => {
                    if (key !== 'activeTimers') {
                        if (typeof state[key] === 'object' && state[key] !== null) {
                            state[key] = {};
                        } else {
                            state[key] = null;
                        }
                    }
                });
                
                // Reset to initial state
                state.level = 1;
                state.currentXP = 0;
                state.totalXP = 0;
                state.totalTargets = 0;
                state.completedTargets = 0;
                state.targets = [];
                state.achievements = {
                    firstTarget: false,
                    level5: false,
                    level10: false
                };
                state.user = {
                    name: "",
                    profilePic: "",
                    userId: "",
                    email: "",
                    publicProfile: true,
                    selectedAvatar: "warrior"
                };
                state.mainCounter = {
                    title: "Project Deadline",
                    date: "2023-12-31",
                    daysLeft: 14
                };
                state.settings = {
                    notifications: true,
                    soundEffects: true,
                    animations: true,
                    browserNotifications: true
                };
                state.leaderboard = [];
                state.activityLog = [];
                state.workSessions = {};
                state.friends = {};
                state.friendRequests = {};
                state.pendingRequests = {};
                
                updateUserProfile();
                updateUI();
                updateSoundToggleUI();
                elements.mainContainer.style.display = 'none';
                showAuthModal();
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        // Show main UI
        function showMainUI() {
            elements.loading.style.display = 'none';
            elements.mainContainer.style.display = 'block';
            
            // Update user info
            updateUserProfile();
            
            // Load leaderboard
            loadLeaderboard();
            
            // Load friends
            loadFriends();
        }

        // Update user profile display
        function updateUserProfile() {
            const user = auth.currentUser;
            
            if (user && user.photoURL) {
                elements.userAvatarImg.src = user.photoURL;
                elements.userAvatarImg.style.display = 'block';
                elements.userAvatarText.style.display = 'none';
                
                // Update mobile avatar
                elements.mobileUserAvatarImg.src = user.photoURL;
                elements.mobileUserAvatarImg.style.display = 'block';
                elements.mobileUserAvatarText.style.display = 'none';
            } else {
                // Use selected avatar
                const avatarEmoji = avatarOptions[state.user.selectedAvatar] || "⚔️";
                elements.userAvatarText.textContent = avatarEmoji;
                elements.userAvatarText.style.display = 'block';
                elements.userAvatarImg.style.display = 'none';
                
                // Update mobile avatar
                elements.mobileUserAvatarText.textContent = avatarEmoji;
                elements.mobileUserAvatarText.style.display = 'block';
                elements.mobileUserAvatarImg.style.display = 'none';
            }
            
            elements.userNameDisplay.textContent = state.user.name || (user ? user.displayName || "Hunter" : "Hunter");
            elements.userLevel.textContent = state.level;
            elements.userTargets.textContent = state.totalTargets;
            elements.userCompleted.textContent = state.completedTargets;
            elements.userDays.textContent = state.mainCounter.daysLeft;
            
            // Update mobile user info
            elements.mobileUserName.textContent = state.user.name || (user ? user.displayName || "Hunter" : "Hunter");
            elements.mobileUserLevel.textContent = state.level;
            elements.mobileLevel.textContent = state.level;
        }

        // Show profile edit modal
        function showProfileModal() {
            const user = auth.currentUser;
            elements.profileName.value = state.user.name || (user ? user.displayName || "" : "");
            
            // Set selected avatar
            elements.avatarOptions.forEach(option => {
                if (option.dataset.avatar === state.user.selectedAvatar) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            elements.profileModal.style.display = 'flex';
        }

        // Hide profile edit modal
        function hideProfileModal() {
            elements.profileModal.style.display = 'none';
        }

        // Save profile changes
        function saveProfile() {
            const newName = elements.profileName.value.trim();
            
            if (!newName) {
                showNotification('Error', 'Please enter your name', 'fas fa-exclamation-triangle');
                return;
            }
            
            state.user.name = newName;
            
            // Get selected avatar with ownership gating
            const selectedAvatarOption = document.querySelector('.avatar-option.selected');
            if (selectedAvatarOption) {
                const selectedKey = selectedAvatarOption.dataset.avatar;
                const itemId = 'avatar_' + selectedKey;
                if (state.user.selectedAvatar !== selectedKey && !isOwned(itemId)) {
                    showNotification('Locked Avatar', 'Purchase this avatar in the Shop', 'fas fa-lock');
                } else {
                    state.user.selectedAvatar = selectedKey;
                }
            }
            
            // Update Firebase user profile
            const user = auth.currentUser;
            if (user) {
                user.updateProfile({
                    displayName: newName
                }).then(() => {
                    updateUserProfile();
                    hideProfileModal();
                    saveState();
                    
                    showNotification('Profile Updated', 'Your profile has been updated successfully', 'fas fa-user-edit');
                }).catch((error) => {
                    showNotification('Error', 'Failed to update profile', 'fas fa-exclamation-triangle');
                });
            }
        }

        // Switch between sections
        function switchSection(sectionName) {
            // Update navigation buttons
            elements.navBtns.forEach(btn => {
                if (btn.dataset.section === sectionName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide sections
            elements.sectionContents.forEach(section => {
                if (section.id === `${sectionName}-section`) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
            
            // Special handling for analytics section
            if (sectionName === 'analytics') {
                renderWorkTimeChart();
            }
            // Populate store and inventory when navigating
            if (sectionName === 'store') {
                populateStore();
            }
            if (sectionName === 'inventory') {
                renderInventory();
            }
        }

        // Load friends data
        function loadFriends() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Load friends list
            database.ref('users/' + user.uid + '/friends').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        state.friends = snapshot.val();
                    }
                    renderFriendsList();
                });
            
            // Load friend requests
            database.ref('users/' + user.uid + '/friendRequests').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        state.friendRequests = snapshot.val();
                    }
                    renderFriendRequests();
                });
            
            // Load pending requests
            database.ref('users/' + user.uid + '/pendingRequests').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        state.pendingRequests = snapshot.val();
                    }
                });
        }

        // Render friends list
        function renderFriendsList() {
            if (Object.keys(state.friends).length === 0) {
                elements.friendsList.innerHTML = `
                    <div class="empty-targets">
                        <p>You haven't added any friends yet.</p>
                        <p>Search for friends to connect with other hunters!</p>
                    </div>
                `;
                return;
            }
            
            let friendsHTML = '';
            Object.keys(state.friends).forEach(friendId => {
                const friend = state.friends[friendId];
                const avatarEmoji = avatarOptions[friend.selectedAvatar] || "⚔️";
                
                friendsHTML += `
                    <div class="friend-item">
                        <div class="friend-info">
                            <div class="friend-avatar">
                                ${friend.profilePic ? `<img src="${friend.profilePic}" alt="${friend.name}">` : avatarEmoji}
                            </div>
                            <div class="friend-details">
                                <h4>${friend.name}</h4>
                                <p>Level ${friend.level} Hunter</p>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-small btn-decline remove-friend" data-friend="${friendId}">
                                <i class="fas fa-user-minus"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.friendsList.innerHTML = friendsHTML;
            
            // Add event listeners to remove friend buttons
            elements.friendsList.querySelectorAll('.remove-friend').forEach(btn => {
                btn.addEventListener('click', function() {
                    const friendId = this.dataset.friend;
                    removeFriend(friendId);
                });
            });
        }

        // Render friend requests
        function renderFriendRequests() {
            if (Object.keys(state.friendRequests).length === 0) {
                elements.requestsList.innerHTML = `
                    <div class="empty-targets">
                        <p>No pending friend requests.</p>
                    </div>
                `;
                return;
            }
            
            let requestsHTML = '';
            Object.keys(state.friendRequests).forEach(requestId => {
                const request = state.friendRequests[requestId];
                const avatarEmoji = avatarOptions[request.selectedAvatar] || "⚔️";
                
                requestsHTML += `
                    <div class="request-item">
                        <div class="request-info">
                            <div class="request-avatar">
                                ${request.profilePic ? `<img src="${request.profilePic}" alt="${request.name}">` : avatarEmoji}
                            </div>
                            <div class="request-details">
                                <h4>${request.name}</h4>
                                <p>Level ${request.level} Hunter</p>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn-small btn-accept accept-request" data-request="${requestId}">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-small btn-decline decline-request" data-request="${requestId}">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.requestsList.innerHTML = requestsHTML;
            
            // Add event listeners to request buttons
            elements.requestsList.querySelectorAll('.accept-request').forEach(btn => {
                btn.addEventListener('click', function() {
                    const requestId = this.dataset.request;
                    acceptFriendRequest(requestId);
                });
            });
            
            elements.requestsList.querySelectorAll('.decline-request').forEach(btn => {
                btn.addEventListener('click', function() {
                    const requestId = this.dataset.request;
                    declineFriendRequest(requestId);
                });
            });
        }

        // Search for friends
        function searchFriends() {
            const searchTerm = elements.friendSearch.value.trim().toLowerCase();
            if (!searchTerm) {
                showNotification('Error', 'Please enter a name to search', 'fas fa-exclamation-triangle');
                return;
            }
            
            // Search in all users (this is a simplified version)
            // In a real app, you would have a better search implementation
            database.ref('users').once('value')
                .then((snapshot) => {
                    const currentUser = auth.currentUser;
                    const results = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        const userId = childSnapshot.key;
                        
                        // Skip current user and existing friends
                        if (userId === currentUser.uid || 
                            state.friends[userId] || 
                            state.pendingRequests[userId]) {
                            return;
                        }
                        
                        // Check if name matches search term
                        if (userData.user && userData.user.name.toLowerCase().includes(searchTerm)) {
                            results.push({
                                id: userId,
                                name: userData.user.name,
                                profilePic: userData.user.profilePic,
                                level: userData.level || 1,
                                selectedAvatar: userData.user.selectedAvatar || "warrior"
                            });
                        }
                    });
                    
                    renderSearchResults(results);
                })
                .catch((error) => {
                    console.error('Error searching for friends:', error);
                    showNotification('Error', 'Failed to search for friends', 'fas fa-exclamation-triangle');
                });
        }

        // Render search results
        function renderSearchResults(results) {
            if (results.length === 0) {
                elements.searchResults.innerHTML = `
                    <div class="empty-targets">
                        <p>No users found with that name.</p>
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '';
            results.forEach(user => {
                const avatarEmoji = avatarOptions[user.selectedAvatar] || "⚔️";
                
                resultsHTML += `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-avatar">
                                ${user.profilePic ? `<img src="${user.profilePic}" alt="${user.name}">` : avatarEmoji}
                            </div>
                            <div class="search-result-details">
                                <h4>${user.name}</h4>
                                <p>Level ${user.level} Hunter</p>
                            </div>
                        </div>
                        <div class="search-result-actions">
                            <button class="btn-small btn-add send-request" data-user="${user.id}">
                                <i class="fas fa-user-plus"></i> Add Friend
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.searchResults.innerHTML = resultsHTML;
            
            // Add event listeners to send request buttons
            elements.searchResults.querySelectorAll('.send-request').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.dataset.user;
                    sendFriendRequest(userId);
                });
            });
        }

        // Send friend request
        function sendFriendRequest(userId) {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            // Add to pending requests
            if (!state.pendingRequests) state.pendingRequests = {};
            state.pendingRequests[userId] = true;
            
            // Save to Firebase
            database.ref('users/' + currentUser.uid + '/pendingRequests/' + userId).set(true);
            
            // Send request to the other user
            const requestData = {
                from: currentUser.uid,
                name: state.user.name,
                profilePic: state.user.profilePic,
                level: state.level,
                selectedAvatar: state.user.selectedAvatar
            };
            
            database.ref('users/' + userId + '/friendRequests/' + currentUser.uid).set(requestData)
                .then(() => {
                    showNotification('Request Sent', 'Friend request sent successfully', 'fas fa-user-plus');
                    // Remove from search results
                    document.querySelector(`.send-request[data-user="${userId}"]`).closest('.search-result-item').remove();
                })
                .catch((error) => {
                    console.error('Error sending friend request:', error);
                    showNotification('Error', 'Failed to send friend request', 'fas fa-exclamation-triangle');
                });
        }

        // Accept friend request
        function acceptFriendRequest(requestId) {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            const request = state.friendRequests[requestId];
            
            // Add to friends list
            if (!state.friends) state.friends = {};
            state.friends[requestId] = {
                name: request.name,
                profilePic: request.profilePic,
                level: request.level,
                selectedAvatar: request.selectedAvatar || "warrior"
            };
            
            // Remove from friend requests
            delete state.friendRequests[requestId];
            
            // Save to Firebase
            database.ref('users/' + currentUser.uid + '/friends/' + requestId).set(state.friends[requestId]);
            database.ref('users/' + currentUser.uid + '/friendRequests/' + requestId).remove();
            
            // Notify the other user
            const currentUserData = {
                name: state.user.name,
                profilePic: state.user.profilePic,
                level: state.level,
                selectedAvatar: state.user.selectedAvatar
            };
            
            database.ref('users/' + requestId + '/friends/' + currentUser.uid).set(currentUserData);
            database.ref('users/' + requestId + '/pendingRequests/' + currentUser.uid).remove();
            
            showNotification('Friend Added', `${request.name} is now your friend!`, 'fas fa-user-friends');
            renderFriendRequests();
            renderFriendsList();
        }

        // Decline friend request
        function declineFriendRequest(requestId) {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            // Remove from friend requests
            delete state.friendRequests[requestId];
            
            // Save to Firebase
            database.ref('users/' + currentUser.uid + '/friendRequests/' + requestId).remove();
            
            // Notify the other user
            database.ref('users/' + requestId + '/pendingRequests/' + currentUser.uid).remove();
            
            showNotification('Request Declined', 'Friend request declined', 'fas fa-user-times');
            renderFriendRequests();
        }

        // Remove friend
        function removeFriend(friendId) {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            const friendName = state.friends[friendId].name;
            
            // Remove from friends list
            delete state.friends[friendId];
            
            // Save to Firebase
            database.ref('users/' + currentUser.uid + '/friends/' + friendId).remove();
            
            // Notify the other user
            database.ref('users/' + friendId + '/friends/' + currentUser.uid).remove();
            
            showNotification('Friend Removed', `${friendName} has been removed from your friends`, 'fas fa-user-minus');
            renderFriendsList();
        }

        // Render work time chart
        function renderWorkTimeChart() {
            const ctx = elements.workTimeChart.getContext('2d');
            
            // Get last 7 days
            const days = [];
            const workTimes = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                
                // Calculate total work time for this day
                let totalSeconds = 0;
                if (state.workSessions[dateString]) {
                    state.workSessions[dateString].forEach(session => {
                        if (session.end) {
                            const startTime = session.start.split(':').map(Number);
                            const endTime = session.end.split(':').map(Number);
                            
                            const startSeconds = startTime[0] * 3600 + startTime[1] * 60 + startTime[2];
                            const endSeconds = endTime[0] * 3600 + endTime[1] * 60 + endTime[2];
                            
                            totalSeconds += (endSeconds - startSeconds);
                        }
                    });
                }
                
                workTimes.push(totalSeconds / 3600); // Convert to hours
            }
            
            // Destroy existing chart if it exists
            if (window.workTimeChartInstance) {
                window.workTimeChartInstance.destroy();
            }
            
            // Create new chart
            window.workTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Work Time (hours)',
                        data: workTimes,
                        backgroundColor: 'rgba(138, 43, 226, 0.7)',
                        borderColor: 'rgba(138, 43, 226, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return value + 'h';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Work Time: ${context.parsed.y.toFixed(2)} hours`;
                                }
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const day = days[index];
                            showWorkSessions(day, index);
                        }
                    }
                }
            });
        }

        // Show work sessions for a specific day
        function showWorkSessions(day, index) {
            // Calculate the date for the selected day
            const date = new Date();
            date.setDate(date.getDate() - (6 - index));
            const dateString = date.toISOString().split('T')[0];
            
            elements.selectedDay.textContent = `${day} - ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            
            let sessionsHTML = '';
            if (state.workSessions[dateString] && state.workSessions[dateString].length > 0) {
                state.workSessions[dateString].forEach((session, i) => {
                    const target = state.targets.find(t => t.id === (session.linkedTargetId || session.targetId));
                    const baseName = session.targetId === 'pomodoro' ? 'Pomodoro Focus' : (target ? target.title : 'Unknown Target');
                    const labelPart = session.quickLabel ? ` - ${session.quickLabel}` : (session.targetId === 'pomodoro' && target ? ` - ${target.title}` : '');
                    const targetName = baseName + labelPart;
                    
                    let duration = 'In progress';
                    if (session.end) {
                        const startTime = session.start.split(':').map(Number);
                        const endTime = session.end.split(':').map(Number);
                        
                        const startSeconds = startTime[0] * 3600 + startTime[1] * 60 + startTime[2];
                        const endSeconds = endTime[0] * 3600 + endTime[1] * 60 + endTime[2];
                        
                        duration = formatTimeShort(endSeconds - startSeconds);
                    }
                    
                    sessionsHTML += `
                        <div class="time-session">
                            <div>
                                <strong>${targetName}</strong>
                                <div>${session.start} - ${session.end || 'Now'}</div>
                            </div>
                            <div>${duration}</div>
                        </div>
                    `;
            });
            } else {
                sessionsHTML = `<p>No work sessions recorded for this day.</p>`;
            }
            
            elements.timeSessions.innerHTML = sessionsHTML;
            elements.timeDetails.classList.add('active');
        }

        // Load leaderboard
        function loadLeaderboard() {
            database.ref('users').once('value')
                .then((snapshot) => {
                    const users = [];
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.user && userData.user.publicProfile !== false) {
                            users.push({
                                name: userData.user.name,
                                level: userData.level,
                                totalXP: userData.totalXP,
                                profilePic: userData.user.profilePic,
                                selectedAvatar: userData.user.selectedAvatar || "warrior"
                            });
                        }
                    });
                    
                    // Sort by level and XP
                    state.leaderboard = users
                        .sort((a, b) => (b.level * 1000 + b.totalXP) - (a.level * 1000 + a.totalXP))
                        .slice(0, 10);
                        
                    renderLeaderboard();
                })
                .catch((error) => {
                    console.error('Error loading leaderboard:', error);
                });
        }

        // Render leaderboard
        function renderLeaderboard() {
            if (state.leaderboard.length === 0) {
                elements.leaderboardList.innerHTML = `
                    <div class="empty-targets">
                        <p>No users on leaderboard yet.</p>
                    </div>
                `;
                return;
            }
            
            let leaderboardHTML = '';
            state.leaderboard.forEach((user, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? 'leaderboard-rank top-' + rank : 'leaderboard-rank';
                const avatarEmoji = avatarOptions[user.selectedAvatar] || "⚔️";
                
                leaderboardHTML += `
                    <div class="leaderboard-item">
                        <div class="${rankClass}">${rank}</div>
                        <div class="leaderboard-user">
                            <div class="leaderboard-avatar">
                                ${user.profilePic ? `<img src="${user.profilePic}" alt="${user.name}">` : avatarEmoji}
                            </div>
                            <div class="leaderboard-info">
                                <h4>${user.name}</h4>
                                <p>Hunter</p>
                            </div>
                        </div>
                        <div class="leaderboard-stats">
                            <div class="leaderboard-level">Level ${user.level}</div>
                            <div class="leaderboard-xp">${user.totalXP} XP</div>
                        </div>
                    </div>
                `;
            });
            
            elements.leaderboardList.innerHTML = leaderboardHTML;
        }

        // Initialize the app
                function updateFocusAnalyticsDisplay() {
                    let totalSeconds = 0;
                    let sessions = 0;
                    let longest = 0;
                    Object.keys(state.workSessions || {}).forEach(date => {
                        (state.workSessions[date] || []).forEach(sess => {
                            if (sess.targetId === 'pomodoro' && sess.end) {
                                sessions++;
                                const st = sess.start.split(':').map(Number);
                                const et = sess.end.split(':').map(Number);
                                const ss = st[0]*3600 + st[1]*60 + st[2];
                                const es = et[0]*3600 + et[1]*60 + et[2];
                                const dur = Math.max(0, es - ss);
                                totalSeconds += dur;
                                if (dur > longest) longest = dur;
                            }
                        });
                    });
                    const totalsEl = document.getElementById('focus-total');
                    const sessionsEl = document.getElementById('focus-sessions');
                    const avgEl = document.getElementById('focus-average');
                    const longestEl = document.getElementById('focus-longest');
                    if (totalsEl) totalsEl.textContent = Math.round(totalSeconds/60) + 'm';
                    if (sessionsEl) sessionsEl.textContent = String(sessions);
                    if (avgEl) avgEl.textContent = (sessions > 0 ? Math.round((totalSeconds/60)/sessions) : 0) + 'm';
                    if (longestEl) longestEl.textContent = Math.round(longest/60) + 'm';
                }

function init() {
            // Create particles (lightweight)
            createParticles();
            updateSoundToggleUI();
            window.addEventListener('click', () => sound.init(), { once: true });
            
            // Check authentication state
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    elements.loading.style.display = 'none';
                    showMainUI();
                    loadState();
                } else {
                    // User is signed out
                    elements.loading.style.display = 'none';
                    showAuthModal();
                }
            });
            
            // Initialize store and inventory defaults
            initStore();
            updateUI();
            setupEventListeners();
            
            setInterval(updateMainCounter, 60 * 1000);
            updateMainCounter();
        }

        // Update the UI based on current state
        function updateUI() {
            // Update desktop dashboard
            elements.currentLevel.textContent = state.level;
            elements.userLevel.textContent = state.level;
            
            const xpNeeded = calculateXPNeeded();
            const xpPercent = Math.min(100, (state.currentXP / xpNeeded) * 100);
            
            elements.xpText.textContent = `${xpNeeded} XP to Level ${state.level + 1}`;
            elements.xpBar.style.width = `${xpPercent}%`;
            elements.xpDetails.textContent = `EXPERIENCE ${state.currentXP} / ${xpNeeded}`;
            
            elements.totalTargets.textContent = state.totalTargets;
            elements.completedTargets.textContent = state.completedTargets;
            elements.totalXp.textContent = state.totalXP;
            
            // Update mobile dashboard
            elements.mobileLevel.textContent = state.level;
            elements.mobileUserLevel.textContent = state.level;
            elements.mobileTotalTargets.textContent = state.totalTargets;
            elements.mobileCompletedTargets.textContent = state.completedTargets;
            elements.mobileTotalXp.textContent = state.totalXP;
            elements.mobileDaysLeft.textContent = state.mainCounter.daysLeft;
            
            elements.mobileXpProgress.textContent = `${state.currentXP} / ${xpNeeded} XP`;
            elements.mobileXpBar.style.width = `${xpPercent}%`;
            elements.mobileCurrentLevel.textContent = state.level;
            elements.mobileNextLevel.textContent = state.level + 1;
            if (elements.storeCoinsDisplay) {
                elements.storeCoinsDisplay.textContent = state.coins || 0;
            }
            
            elements.mobileTargetsCount.textContent = `${state.targets.length} target${state.targets.length !== 1 ? 's' : ''}`;
            
            updateUserProfile();
            updateMainCounter();
            renderTargets();
            renderMobileTargets();
            
            // Update settings toggles
            elements.browserNotifications.checked = state.settings.browserNotifications;
            elements.soundEffects.checked = state.settings.soundEffects;
            elements.animations.checked = state.settings.animations;
            elements.publicProfile.checked = state.user.publicProfile;
            applySelectedTheme();
            updateSoundToggleUI();
        }

        // ---------- Store & Inventory Logic ----------
        const defaultStoreItems = [
            { id: 'avatar_warrior', type: 'avatar', name: 'Warrior Avatar', emoji: '⚔️', price: 100, data: { avatar: 'warrior' } },
            { id: 'avatar_mage', type: 'avatar', name: 'Mage Avatar', emoji: '🧙', price: 100, data: { avatar: 'mage' } },
            { id: 'avatar_archer', type: 'avatar', name: 'Archer Avatar', emoji: '🏹', price: 100, data: { avatar: 'archer' } },
            { id: 'avatar_knight', type: 'avatar', name: 'Knight Avatar', emoji: '🛡️', price: 120, data: { avatar: 'knight' } },
            { id: 'avatar_ninja', type: 'avatar', name: 'Ninja Avatar', emoji: '🥷', price: 120, data: { avatar: 'ninja' } },
            { id: 'avatar_wizard', type: 'avatar', name: 'Wizard Avatar', emoji: '🔮', price: 150, data: { avatar: 'wizard' } },
            { id: 'avatar_berserker', type: 'avatar', name: 'Berserker Avatar', emoji: '⚡', price: 150, data: { avatar: 'berserker' } },
            { id: 'avatar_assassin', type: 'avatar', name: 'Assassin Avatar', emoji: '🗡️', price: 150, data: { avatar: 'assassin' } },
            { id: 'upgrade_xpdoubler', type: 'upgrade', name: 'XP Doubler', emoji: '✨', price: 500, data: { xpBoost: 2 } },
            { id: 'theme_shadow', type: 'theme', name: 'Shadow Theme', emoji: '🎨', price: 200, data: { primary: '#0a0a1a', secondary: '#1a1a2e', accent: '#4a00e0', accentLight: '#8e2de2', text: '#ffffff' } },
            { id: 'theme_neon', type: 'theme', name: 'Neon Theme', emoji: '🌟', price: 200, data: { primary: '#00120b', secondary: '#0b2e26', accent: '#00ff9d', accentLight: '#6affc5', text: '#eafff7' } }
        ];

        let pendingPurchaseId = null;

        function initStore() {
            if (!Array.isArray(state.storeItems) || state.storeItems.length === 0) {
                state.storeItems = defaultStoreItems;
            }
            if (!Array.isArray(state.inventory)) {
                state.inventory = [];
            }
            if (typeof state.coins !== 'number') state.coins = 0;
            if (typeof state.xpBoost !== 'number') state.xpBoost = 1;

            populateStore();
            renderInventory();
        }

        function isOwned(itemId) {
            return (state.inventory || []).some(inv => inv.id === itemId);
        }

        function populateStore() {
            if (!elements.storeItems) return;
            const items = state.storeItems || [];
            if (items.length === 0) {
                elements.storeItems.innerHTML = '<div class="empty-targets"><p>No items available.</p></div>';
                return;
            }
            const html = items.map(item => {
                const owned = isOwned(item.id);
                return `
                    <div class="store-item" data-id="${item.id}">
                        <div class="store-item-left">
                            <div class="store-item-icon">${item.emoji}</div>
                            <div class="store-item-info">
                                <div class="store-item-name">${item.name}</div>
                                <div class="store-item-price"><i class="fas fa-coins"></i> ${item.price} Coins</div>
                            </div>
                        </div>
                        <div class="store-item-actions">
                            ${owned ? '<span class="badge owned">Owned</span>' : `<button class="btn" data-action=\"purchase\" data-id=\"${item.id}\"><i class=\"fas fa-shopping-cart\"></i> Buy</button>`}
                        </div>
                    </div>
                `;
            }).join('');
            elements.storeItems.innerHTML = html;
        }

        function renderInventory() {
            if (!elements.inventoryList) return;
            const inv = state.inventory || [];
            if (inv.length === 0) {
                elements.inventoryList.innerHTML = '<div class="empty-targets"><p>No items acquired yet.</p></div>';
                return;
            }
            const html = inv.map(item => {
                let action = '';
                if (item.type === 'avatar') {
                    action = `<button class="btn" data-action="equip" data-id="${item.id}"><i class="fas fa-user"></i> Equip</button>`;
                } else if (item.type === 'theme') {
                    const active = state.settings && state.settings.selectedTheme === item.id;
                    action = active ? '<span class="badge" style="color:var(--accent-light);">Active</span>' : `<button class="btn" data-action="equip" data-id="${item.id}"><i class="fas fa-palette"></i> Equip</button>`;
                } else {
                    action = '<span class="badge" style="color:var(--accent-light);">Active</span>';
                }
                const subtype = item.type === 'avatar' ? 'Avatar' : (item.type === 'theme' ? 'Theme' : 'Upgrade');
                return `
                    <div class="inventory-item" data-id="${item.id}" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border:1px solid var(--card-border); border-radius:10px; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="font-size:24px;">${item.emoji}</div>
                            <div>
                                <div style="font-weight:600;">${item.name}</div>
                                <div style="color: var(--text-dim);">${subtype}</div>
                            </div>
                        </div>
                        <div>${action}</div>
                    </div>
                `;
            }).join('');
            elements.inventoryList.innerHTML = html;
        }

        function showPurchaseModal(itemId) {
            pendingPurchaseId = itemId;
            const item = (state.storeItems || []).find(i => i.id === itemId);
            if (!item) return;
            const msg = `Buy "${item.name}" for ${item.price} coins?`;
            const el = document.getElementById('purchase-message');
            if (el) el.textContent = msg;
            if (elements.purchaseModal) elements.purchaseModal.style.display = 'flex';
        }

        function hidePurchaseModal() {
            pendingPurchaseId = null;
            if (elements.purchaseModal) elements.purchaseModal.style.display = 'none';
        }

        function applyItemEffects(item) {
            if (!item) return;
            if (item.type === 'upgrade') {
                if (item.id === 'upgrade_xpdoubler') {
                    state.xpBoost = item.data.xpBoost || 2;
                }
            }
            if (item.type === 'theme') {
                const t = item.data || {};
                state.settings.selectedTheme = item.id;
                state.settings.themeVars = {
                    primary: t.primary,
                    secondary: t.secondary,
                    accent: t.accent,
                    accentLight: t.accentLight,
                    text: t.text
                };
                applySelectedTheme();
            }
        }

        function applySelectedTheme() {
            const vars = (state.settings && state.settings.themeVars) || null;
            if (!vars) return;
            const root = document.documentElement;
            if (vars.primary) root.style.setProperty('--primary', vars.primary);
            if (vars.secondary) root.style.setProperty('--secondary', vars.secondary);
            if (vars.accent) root.style.setProperty('--accent', vars.accent);
            if (vars.accentLight) root.style.setProperty('--accent-light', vars.accentLight);
            if (vars.text) root.style.setProperty('--text', vars.text);
        }

        function purchaseItem(itemId) {
            const item = (state.storeItems || []).find(i => i.id === itemId);
            if (!item) return;
            if (isOwned(itemId)) {
                showNotification('Already Owned', 'You already own this item', 'fas fa-info-circle');
                hidePurchaseModal();
                return;
            }
            const price = item.price || 0;
            if ((state.coins || 0) < price) {
                showNotification('Insufficient Coins', 'Earn more coins by completing targets', 'fas fa-exclamation-triangle');
                hidePurchaseModal();
                return;
            }
            state.coins -= price;
            state.inventory.push(item);
            applyItemEffects(item);
            saveState();
            updateUI();
            populateStore();
            renderInventory();
            hidePurchaseModal();
            showNotification('Purchase Successful', `You bought ${item.name}`, 'fas fa-shopping-bag');
            sound.play('success');
        }

        // Calculate XP needed for next level
        function calculateXPNeeded() {
            return state.level * 500;
        }

        // Render the targets list
        function renderTargets() {
            if (state.targets.length === 0) {
                elements.targetsList.innerHTML = `
                    <div class="empty-targets">
                        <p>No active targets yet.</p>
                        <button class="btn" id="add-first-target">
                            <i class="fas fa-plus"></i> Add Your First Target
                        </button>
                    </div>
                `;
                document.getElementById('add-first-target').addEventListener('click', showTargetModal);
                return;
            }
            
            let targetsHTML = '';
            state.targets.forEach((target, index) => {
                const deadlineText = target.deadline ? 
                    `<p class="target-timer"><i class="fas fa-clock"></i> Due: ${formatDate(target.deadline)} (${getDaysUntilDeadline(target.deadline)} days left)</p>` : '';
                
                const timeSpent = target.timeSpent || 0;
                const timer = state.activeTimers[target.id];
                const isRunning = timer && timer.running;
                
                targetsHTML += `
                    <div class="target-item" data-id="${target.id}" style="animation-delay: ${index * 0.1}s">
                        <div class="target-info">
                            <h3><i class="fas fa-bullseye"></i> ${target.title}</h3>
                            <p><i class="fas fa-bolt"></i> ${target.xp} XP</p>
                            ${deadlineText}
                            <div class="timer-container">
                                <div class="timer-display">${formatTime(timeSpent)}</div>
                                <button class="timer-btn start ${isRunning ? 'hidden' : ''}" data-action="start" data-target="${target.id}">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button class="timer-btn pause ${isRunning ? '' : 'hidden'}" data-action="pause" data-target="${target.id}">
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button class="timer-btn reset" data-action="reset" data-target="${target.id}">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                                <button class="timer-btn fullscreen" data-action="fullscreen" data-target="${target.id}">
                                    <i class="fas fa-expand"></i> Fullscreen
                                </button>
                            </div>
                        </div>
                        <div class="target-actions">
                            <button class="btn-complete complete-target" data-target="${target.id}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            <button class="btn-delete delete-target" data-target="${target.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.targetsList.innerHTML = targetsHTML;
            
            // Add event listeners to target buttons using event delegation
            elements.targetsList.addEventListener('click', function(e) {
                const target = e.target.closest('.complete-target') || 
                              e.target.closest('.delete-target') ||
                              e.target.closest('.timer-btn');
                
                if (!target) return;
                
                const targetId = target.dataset.target || target.closest('.target-item').dataset.id;
                
                if (target.classList.contains('complete-target')) {
                    completeTarget(targetId);
                } else if (target.classList.contains('delete-target')) {
                    deleteTarget(targetId);
                } else if (target.classList.contains('timer-btn')) {
                    const action = target.dataset.action;
                    
                    switch(action) {
                        case 'start':
                            startTimer(targetId);
                            break;
                        case 'pause':
                            pauseTimer(targetId);
                            break;
                        case 'reset':
                            resetTimer(targetId);
                            break;
                        case 'fullscreen':
                            openFullscreenTimer(targetId);
                            break;
                    }
                }
            });
        }

        // Render mobile targets
        function renderMobileTargets() {
            if (state.targets.length === 0) {
                elements.mobileRecentTargetsList.innerHTML = `
                    <div class="mobile-empty-targets">
                        <p>No active targets yet.</p>
                        <button class="mobile-add-target-btn" id="mobile-add-first-target">
                            <i class="fas fa-plus"></i> Add Your First Target
                        </button>
                    </div>
                `;
                document.getElementById('mobile-add-first-target').addEventListener('click', showTargetModal);
                return;
            }
            
            let targetsHTML = '';
            
            // Show only the first 3 targets for mobile
            const recentTargets = state.targets.slice(0, 3);
            
            recentTargets.forEach((target, index) => {
                const timeSpent = target.timeSpent || 0;
                const timer = state.activeTimers[target.id];
                const isRunning = timer && timer.running;
                
                // Calculate progress percentage (for demo purposes)
                const progress = Math.min(100, (timeSpent / 3600) * 100); // 1 hour = 100%
                
                targetsHTML += `
                    <div class="mobile-target-item" data-id="${target.id}">
                        <div class="mobile-target-header">
                            <div class="mobile-target-name">${target.title}</div>
                            <div class="mobile-target-xp">${target.xp} XP</div>
                        </div>
                        <div class="mobile-target-progress">
                            <div class="mobile-target-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div class="mobile-target-time">
                            <i class="fas fa-clock"></i>
                            <span>${formatTime(timeSpent)}</span>
                        </div>
                        <div class="mobile-target-actions">
                            <button class="mobile-target-btn start" data-action="start" data-target="${target.id}">
                                <i class="fas fa-play"></i> ${isRunning ? 'Running' : 'Start'}
                            </button>
                            <button class="mobile-target-btn complete" data-action="complete" data-target="${target.id}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add "View All" button if there are more than 3 targets
            if (state.targets.length > 3) {
                targetsHTML += `
                    <button class="mobile-add-target-btn" id="mobile-view-all-targets" style="margin-top: 15px;">
                        <i class="fas fa-list"></i> View All ${state.targets.length} Targets
                    </button>
                `;
            }
            
            elements.mobileRecentTargetsList.innerHTML = targetsHTML;
            
            // Add event listeners to mobile target buttons
            elements.mobileRecentTargetsList.addEventListener('click', function(e) {
                const target = e.target.closest('.mobile-target-btn');
                
                if (!target) return;
                
                const targetId = target.dataset.target || target.closest('.mobile-target-item').dataset.id;
                const action = target.dataset.action;
                
                if (action === 'start') {
                    startTimer(targetId);
                    // Update button text
                    target.innerHTML = '<i class="fas fa-play"></i> Running';
                } else if (action === 'complete') {
                    completeTarget(targetId);
                }
            });
            
            // Add event listener for "View All" button
            const viewAllBtn = document.getElementById('mobile-view-all-targets');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', function() {
                    switchSection('targets');
                });
            }
        }

        // Show the target creation modal
        function showTargetModal() {
            elements.targetTitle.value = '';
            elements.targetXp.value = '50';
            elements.targetDeadline.value = '';
            if (elements.targetType) elements.targetType.value = 'daily';
            elements.targetModal.style.display = 'flex';
        }

        // Hide the target creation modal
        function hideTargetModal() {
            elements.targetModal.style.display = 'none';
        }

        // Show the date modal
        function showDateModal() {
            elements.mainDateTitle.value = state.mainCounter.title;
            elements.mainTargetDate.value = state.mainCounter.date;
            elements.dateModal.style.display = 'flex';
        }

        // Hide the date modal
        function hideDateModal() {
            elements.dateModal.style.display = 'none';
        }

        // Create a new target
        function createTarget() {
            const title = elements.targetTitle.value.trim();
            const xp = parseInt(elements.targetXp.value);
            const deadline = elements.targetDeadline.value;
            const type = elements.targetType ? elements.targetType.value : 'daily';
            
            if (!title) {
                showNotification('Error', 'Please enter a target title', 'fas fa-exclamation-triangle');
                return;
            }
            
            if (xp < 10 || xp > 500) {
                showNotification('Error', 'XP must be between 10 and 500', 'fas fa-exclamation-triangle');
                return;
            }
            
            const newTarget = {
                id: Date.now().toString(),
                title: title,
                xp: xp,
                type: type,
                createdAt: new Date().toISOString(),
                deadline: deadline || null,
                timeSpent: 0
            };
            
            state.targets.push(newTarget);
            state.totalTargets++;
            
            saveState();
            updateUI();
            hideTargetModal();
            showNotification('Target Added', `"${title}" has been added to your targets`, 'fas fa-bullseye');
        }

        // Save main date
        function saveMainDate() {
            const title = elements.mainDateTitle.value.trim();
            const date = elements.mainTargetDate.value;
            
            if (!title) {
                showNotification('Error', 'Please enter a goal title', 'fas fa-exclamation-triangle');
                return;
            }
            
            if (!date) {
                showNotification('Error', 'Please select a target date', 'fas fa-exclamation-triangle');
                return;
            }
            
            state.mainCounter.title = title;
            state.mainCounter.date = date;
            
            saveState();
            updateUI();
            hideDateModal();
            showNotification('Goal Updated', `Your main goal has been set to ${formatDate(date)}`, 'fas fa-calendar-day');
            
            updateMainCounter();
        }

        // Complete a target
        function completeTarget(targetId) {
            const targetIndex = state.targets.findIndex(t => t.id === targetId);
            if (targetIndex === -1) return;
            
            const target = state.targets[targetIndex];
            const baseXp = target.xp;
            const xpGained = Math.floor(baseXp * (state.xpBoost || 1));
            const coinsEarned = Math.max(1, Math.floor(xpGained / 10));
            
            // Stop timer if running
            if (state.activeTimers[targetId]) {
                clearInterval(state.activeTimers[targetId].interval);
                delete state.activeTimers[targetId];
            }
            
            state.targets.splice(targetIndex, 1);
            state.completedTargets++;
            state.currentXP += xpGained;
            state.totalXP += xpGained;
            state.coins = (state.coins || 0) + coinsEarned;
            
            const xpNeeded = calculateXPNeeded();
            if (state.currentXP >= xpNeeded) {
                levelUp();
            }
            
            checkAchievements();
            
            saveState();
            updateUI();
            sound.play('success');
            showNotification('Target Completed!', `+${xpGained} XP, +${coinsEarned} Coins`, 'fas fa-check-circle');
            
            const targetElement = document.querySelector(`.target-item[data-id="${targetId}"]`);
            if (targetElement) {
                targetElement.classList.add('completed');
                setTimeout(() => {
                    targetElement.style.opacity = '0';
                    targetElement.style.transform = 'translateX(100px)';
                    setTimeout(() => {
                        targetElement.remove();
                        renderTargets();
                    }, 500);
                }, 1000);
            }
        }

        // Delete a target
        function deleteTarget(targetId) {
            const targetIndex = state.targets.findIndex(t => t.id === targetId);
            if (targetIndex === -1) return;
            
            const target = state.targets[targetIndex];
            
            // Stop timer if running
            if (state.activeTimers[targetId]) {
                clearInterval(state.activeTimers[targetId].interval);
                delete state.activeTimers[targetId];
            }
            
            state.targets.splice(targetIndex, 1);
            
            saveState();
            updateUI();
            showNotification('Target Deleted', `"${target.title}" has been removed`, 'fas fa-trash');
        }

        // Level up the user
        function levelUp() {
            const xpNeeded = calculateXPNeeded();
            
            while (state.currentXP >= xpNeeded) {
                state.currentXP -= xpNeeded;
                state.level++;
            }
            
            elements.newLevel.textContent = state.level;
            elements.levelUp.classList.add('show');
            createConfetti();
            sound.play('levelup');
        }

        // Check and award achievements
        function checkAchievements() {
            if (state.completedTargets === 1 && !state.achievements.firstTarget) {
                state.achievements.firstTarget = true;
                showAchievement('First Target!', 'Completed your first target');
            }
            
            if (state.level >= 5 && !state.achievements.level5) {
                state.achievements.level5 = true;
                showAchievement('Level 5 Reached!', 'You\'re getting stronger!');
            }
            
            if (state.level >= 10 && !state.achievements.level10) {
                state.achievements.level10 = true;
                showAchievement('Level 10 Reached!', 'You\'re a true hunter now!');
            }
            
            saveState();
        }

        // Show achievement badge
        function showAchievement(title, description) {
            elements.achievementTitle.textContent = title;
            elements.achievementDesc.textContent = description;
            elements.achievementBadge.classList.add('show');
            sound.play('achievement');
            
            setTimeout(() => {
                elements.achievementBadge.classList.remove('show');
            }, 5000);
        }

        // Set up event listeners
        function setupEventListeners() {
            // Authentication tabs
            elements.loginTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // Update active tab
                    elements.loginTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show active form
                    elements.loginForms.forEach(form => {
                        form.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-form`).classList.add('active');
                });
            });
            
            // Email/Password Sign In
            elements.signinEmailBtn.addEventListener('click', signInWithEmail);
            elements.signinPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    signInWithEmail();
                }
            });
            
            // Forgot Password
            document.getElementById('forgot-password-link').addEventListener('click', function(e) {
                e.preventDefault();
                resetPassword();
            });
            // Settings Password Reset
            const settingsResetBtn = document.getElementById('settings-password-reset');
            if (settingsResetBtn) {
                settingsResetBtn.addEventListener('click', function() {
                    resetPassword();
                });
            }
            
            // Email/Password Sign Up
            elements.signupEmailBtn.addEventListener('click', signUpWithEmail);
            elements.signupPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    signUpWithEmail();
                }
            });
            
            // Google Sign In
            elements.googleSignin.addEventListener('click', signInWithGoogle);
            elements.googleSignup.addEventListener('click', signInWithGoogle);
            
            // User profile click - only on user details area (avatar/name), not controls
            elements.userProfile.addEventListener('click', function(e) {
                // Only open profile modal if clicking on user-details area, not controls
                if (e.target.closest('.user-details') || e.target.closest('.user-stats')) {
                    showProfileModal();
                }
            });
            
            // Logout button
            elements.logoutBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent bubbling to user-profile
                logoutUser();
            });
            if (elements.soundToggle) {
                elements.soundToggle.addEventListener('click', toggleSound);
            }
            
            // Profile modal events
            elements.cancelProfile.addEventListener('click', hideProfileModal);
            elements.saveProfile.addEventListener('click', saveProfile);
            
            // Avatar selection with ownership gating
            elements.avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const avatarKey = this.dataset.avatar;
                    const itemId = 'avatar_' + avatarKey;
                    // Allow selecting current avatar; otherwise require ownership
                    if (state.user.selectedAvatar !== avatarKey && !isOwned(itemId)) {
                        showNotification('Locked Avatar', 'Purchase this avatar in the Shop', 'fas fa-lock');
                        if (sound && typeof sound.play === 'function') sound.play('error');
                        return;
                    }
                    elements.avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Navigation events
            elements.navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    switchSection(this.dataset.section);
                });
            });
            
            // Mobile navigation events
            elements.mobileAddTarget.addEventListener('click', showTargetModal);
            elements.mobileSetDate.addEventListener('click', showDateModal);
            elements.mobileViewStats.addEventListener('click', function() {
                switchSection('analytics');
            });
            elements.mobileViewLeaderboard.addEventListener('click', function() {
                switchSection('leaderboard');
            });
            elements.mobileSetDateBtn.addEventListener('click', showDateModal);

            // Store events
            if (elements.storeItems) {
                elements.storeItems.addEventListener('click', (e) => {
                    const buyBtn = e.target.closest('button[data-action="purchase"]');
                    if (buyBtn) {
                        const itemId = buyBtn.dataset.id;
                        showPurchaseModal(itemId);
                    }
                });
            }
            if (elements.confirmPurchase) {
                elements.confirmPurchase.addEventListener('click', () => {
                    if (pendingPurchaseId) purchaseItem(pendingPurchaseId);
                });
            }
            if (elements.cancelPurchase) {
                elements.cancelPurchase.addEventListener('click', hidePurchaseModal);
            }
            if (elements.closePurchaseModal) {
                elements.closePurchaseModal.addEventListener('click', hidePurchaseModal);
            }

            // Inventory events
            if (elements.inventoryList) {
                elements.inventoryList.addEventListener('click', (e) => {
                    const equipBtn = e.target.closest('button[data-action="equip"]');
                    if (equipBtn) {
                        const itemId = equipBtn.dataset.id;
                        const item = (state.inventory || []).find(i => i.id === itemId);
                        if (!item) return;
                        if (item.type === 'avatar') {
                            state.user.selectedAvatar = item.data.avatar;
                            saveState();
                            updateUserProfile();
                            showNotification('Avatar Equipped', `You equipped ${item.name}`, 'fas fa-user');
                            sound.play('success');
                        } else if (item.type === 'theme') {
                            applyItemEffects(item);
                            saveState();
                            updateUI();
                            showNotification('Theme Equipped', `Applied ${item.name}`, 'fas fa-palette');
                            sound.play('success');
                        }
                    }
                });
            }
            
            // Friends tabs
            elements.friendsTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // Update active tab
                    elements.friendsTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show active content
                    elements.friendsContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
            
            // Friends search
            elements.searchFriendsBtn.addEventListener('click', searchFriends);
            elements.friendSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchFriends();
                }
            });
            
            // Settings events
            elements.changeProfileBtn.addEventListener('click', showProfileModal);
            
            // Settings toggles
            elements.browserNotifications.addEventListener('change', function() {
                state.settings.browserNotifications = this.checked;
                saveState();
            });
            
            elements.soundEffects.addEventListener('change', function() {
                // Keep sound manager and header toggle UI in sync
                sound.setEnabled(this.checked);
                saveState();
            });
            
            elements.animations.addEventListener('change', function() {
                state.settings.animations = this.checked;
                saveState();
            });
            
            elements.publicProfile.addEventListener('change', function() {
                state.user.publicProfile = this.checked;
                saveState();
            });
            
            elements.resetData.addEventListener('click', function() {
                if (confirm('Are you sure you want to reset all data? This cannot be undone!')) {
                    const user = auth.currentUser;
                    if (user) {
                        database.ref('users/' + user.uid).remove()
                            .then(() => {
                                location.reload();
                            })
                            .catch((error) => {
                                showNotification('Error', 'Failed to reset data', 'fas fa-exclamation-triangle');
                            });
                    }
                }
            });
            
            elements.exportData.addEventListener('click', function() {
                const dataStr = JSON.stringify(state, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `solo-leveling-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('Data Exported', 'Your data has been downloaded', 'fas fa-download');
            });
            
            // Analytics events
            elements.refreshAnalytics.addEventListener('click', renderWorkTimeChart);
            
            // Leaderboard events
            elements.refreshLeaderboard.addEventListener('click', loadLeaderboard);
            
            // Fullscreen timer events
            elements.fsStart.addEventListener('click', () => {
                const targetId = elements.fullscreenTimer.dataset.targetId;
                startTimer(targetId);
                elements.fsStart.classList.add('hidden');
                elements.fsPause.classList.remove('hidden');
            });
            
            elements.fsPause.addEventListener('click', () => {
                const targetId = elements.fullscreenTimer.dataset.targetId;
                pauseTimer(targetId);
                elements.fsStart.classList.remove('hidden');
                elements.fsPause.classList.add('hidden');
            });
            
            elements.fsReset.addEventListener('click', () => {
                const targetId = elements.fullscreenTimer.dataset.targetId;
                resetTimer(targetId);
                elements.fsStart.classList.remove('hidden');
                elements.fsPause.classList.add('hidden');
            });
            
            elements.fsClose.addEventListener('click', closeFullscreenTimer);
            // Focus mode events (Pomodoro)

    if (elements.focusModeBtn) elements.focusModeBtn.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent bubbling to user-profile
        openFocusOverlay();
    });
            if (elements.pomodoroStart) elements.pomodoroStart.addEventListener('click', startPomodoro);
            if (elements.pomodoroPause) elements.pomodoroPause.addEventListener('click', pausePomodoro);
            if (elements.pomodoroReset) elements.pomodoroReset.addEventListener('click', resetPomodoro);
            if (elements.pomodoroClose) elements.pomodoroClose.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent any event bubbling
                closeFocusOverlay();
            });
            
            // Focus overlay inputs
            if (elements.focusTaskSelect) elements.focusTaskSelect.addEventListener('change', function() {
                state.pomodoro.selectedTargetId = this.value || null;
                updatePomodoroUI();
                saveState();
            });
            if (elements.focusQuickLabel) elements.focusQuickLabel.addEventListener('input', function() {
                state.pomodoro.quickLabel = this.value;
                updatePomodoroUI();
                saveState();
            });
            
            // Existing events
            elements.newTargetBtn.addEventListener('click', showTargetModal);
            elements.cancelTarget.addEventListener('click', hideTargetModal);
            elements.saveTarget.addEventListener('click', createTarget);
            elements.setDateBtn.addEventListener('click', showDateModal);
            elements.cancelDate.addEventListener('click', hideDateModal);
            elements.saveDate.addEventListener('click', saveMainDate);
            elements.dayCounterCard.addEventListener('click', showDateModal);
            elements.closeLevelUp.addEventListener('click', () => {
                elements.levelUp.classList.remove('show');
            });
            
            elements.syncStatus.addEventListener('click', () => {
                if (elements.syncStatus.className.includes('error')) {
                    saveState();
                }
            });
            
            // Modal close events
            elements.authModal.addEventListener('click', (e) => {
                if (e.target === elements.authModal) {
                    // Don't allow closing auth modal - user must authenticate
                }
            });
            
            elements.targetModal.addEventListener('click', (e) => {
                if (e.target === elements.targetModal) {
                    hideTargetModal();
                }
            });
            
            elements.dateModal.addEventListener('click', (e) => {
                if (e.target === elements.dateModal) {
                    hideDateModal();
                }
            });
            
            elements.profileModal.addEventListener('click', (e) => {
                if (e.target === elements.profileModal) {
                    hideProfileModal();
                }
            });
            
            elements.targetTitle.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    createTarget();
                }
            });
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>